<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"><channel><title>东风微鸣 Blog - APM</title><link>https://www.EWhisper.cn/</link><description>Focus on Python/Java/DevOps/Observability</description><lastBuildDate>Tue, 12 Mar 2019 10:58:00 +0800</lastBuildDate><item><title>使用 Dynatrace AppMon 监控 Docker 应用</title><link>https://www.EWhisper.cn/monitoring-docker-app-with-dynatrace.html</link><description>&lt;div class="toc"&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#appmon-dockerized-apps-basic"&gt;使用AppMon 监控 dockerized apps (basic)&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#_1"&gt;基于组合的方案&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#_2"&gt;基于继承的方案&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#qa"&gt;Q&amp;amp;A&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href="#appmon-dockerized-apps-kubernetes-openshift"&gt;使用AppMon 监控 dockerized apps - Kubernetes 和 OpenShift&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#a"&gt;方案A: 基于继承的方案&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#b"&gt;B方案: 基于组合的方案&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;可以配置 AppMon 来监控包裹在docker 容器里的应用:&lt;/p&gt;
&lt;h2 id="appmon-dockerized-apps-basic"&gt;使用AppMon 监控 dockerized apps (basic)&lt;a class="headerlink" href="#appmon-dockerized-apps-basic" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;本章节介绍了将&lt;a href="https://www.dynatrace.com/solutions/application-monitoring/"&gt;AppMon&lt;/a&gt; agent与dockerized应用程序集成的两种方案。这些方案在本页面上被称为&lt;strong&gt;基于组合&lt;/strong&gt;和&lt;strong&gt;基于继承&lt;/strong&gt;的方案。每个方案的利弊都会列出. 但是，建议不要使用&lt;strong&gt;基于继承&lt;/strong&gt;的方法，而是将其用于演示目的。&lt;/p&gt;
&lt;h3 id="_1"&gt;基于组合的方案&lt;a class="headerlink" href="#_1" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;使用基于组合的方案，您可以使用&lt;a href="https://hub.docker.com/r/dynatrace/agent/"&gt;AppMon/agent&lt;/a&gt; Docker镜像(示例见下), 该镜像包含所有的AppMon agent, 你可以配置附加到你的现有的Docker容器中。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;AppMon 6.5 示例:&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;#DOCKERFILE FOR DYNATRACE AGENT&lt;/span&gt;
&lt;span class="k"&gt;FROM&lt;/span&gt;&lt;span class="s"&gt; alpine:3.5&lt;/span&gt;

&lt;span class="k"&gt;LABEL&lt;/span&gt; &lt;span class="nv"&gt;maintainer&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Blazej Tomaszewski &amp;lt;blazej.tomaszewski@dynatrace.com&amp;gt;&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;ARG&lt;/span&gt; DT_HOME
&lt;span class="k"&gt;ARG&lt;/span&gt; BUILD_VERSION
&lt;span class="k"&gt;ARG&lt;/span&gt; VERSION
&lt;span class="k"&gt;ARG&lt;/span&gt; CUID
&lt;span class="k"&gt;ARG&lt;/span&gt; CGID

&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;AGENT_INSTALLER_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dynatrace-agent-&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;BUILD_VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;-unix.jar
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;WSAGENT_INSTALLER32_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dynatrace-wsagent-&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;BUILD_VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;-linux-x86-32.tar
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;WSAGENT_INSTALLER64_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dynatrace-wsagent-&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;BUILD_VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;-linux-x86-64.tar
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;NODE_AGENT_INSTALLER_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dynatrace-one-agent-nodejs-&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;BUILD_VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;-linux-x86.tgz
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;AGENT_INSTALLER_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://files.dynatrace.com/downloads/OnPrem/dynaTrace/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;BUILD_VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;AGENT_INSTALLER_NAME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;WSAGENT_INSTALLER32_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://files.dynatrace.com/downloads/OnPrem/dynaTrace/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;BUILD_VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;WSAGENT_INSTALLER32_NAME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;WSAGENT_INSTALLER64_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://files.dynatrace.com/downloads/OnPrem/dynaTrace/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;BUILD_VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;WSAGENT_INSTALLER64_NAME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;NODE_AGENT_INSTALLER_URL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;https://files.dynatrace.com/downloads/OnPrem/dynaTrace/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;BUILD_VERSION&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;NODE_AGENT_INSTALLER_NAME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;SLAVE_AGENT_PORT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;8001&lt;/span&gt;

&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;DT_INSTALL_DEPS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;curl&lt;span class="se"&gt;\ &lt;/span&gt;openjdk8-jre-base
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;DT_RUNTIME_DEPS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;bash

&lt;span class="k"&gt;COPY&lt;/span&gt; build/scripts/install-agent.sh /usr/bin
&lt;span class="k"&gt;COPY&lt;/span&gt; build/scripts/install-node-agent.sh /usr/bin
&lt;span class="k"&gt;COPY&lt;/span&gt; build/scripts/install-wsagent.sh /usr/bin

&lt;span class="k"&gt;RUN&lt;/span&gt;  apk update &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; apk add --no-cache &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_INSTALL_DEPS&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_RUNTIME_DEPS&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
     mkdir -p &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_HOME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
     /usr/bin/install-agent.sh &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;AGENT_INSTALLER_URL&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
     /usr/bin/install-wsagent.sh &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;WSAGENT_INSTALLER32_URL&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
     /usr/bin/install-wsagent.sh &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;WSAGENT_INSTALLER64_URL&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
     /usr/bin/install-node-agent.sh &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;NODE_AGENT_INSTALLER_URL&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
     mkdir -p &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_HOME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/log/agent &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
     apk del &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_INSTALL_DEPS&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;ADD&lt;/span&gt;  build/bin/dtnginx_offsets.json.tar.gz &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_HOME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;/agent/conf
&lt;span class="k"&gt;COPY&lt;/span&gt; build/scripts/run-wsagent.sh &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_HOME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;COPY&lt;/span&gt; build/scripts/create-user.sh /tmp
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;CUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;CUID&lt;/span&gt;&lt;span class="k"&gt;:-&lt;/span&gt;&lt;span class="nv"&gt;0&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;ENV&lt;/span&gt; &lt;span class="nv"&gt;CGID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;CGID&lt;/span&gt;&lt;span class="k"&gt;:-&lt;/span&gt;&lt;span class="nv"&gt;0&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;RUN&lt;/span&gt; /bin/sh -c /tmp/create-user.sh &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm -rf /tmp/*
&lt;span class="k"&gt;USER&lt;/span&gt;&lt;span class="s"&gt; ${CUID}:${CGID}&lt;/span&gt;

&lt;span class="k"&gt;CMD&lt;/span&gt; &lt;span class="k"&gt;while&lt;/span&gt; true&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; sleep &lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="k"&gt;done&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;从技术上讲，这种方法使用了docker的一个特性，它允许docker容器将其文件系统的一部分导出为&lt;a href="https://docs.docker.com/engine/tutorials/dockervolumes/"&gt;docker卷&lt;/a&gt;，从而使其可以被其他感兴趣的容器获得。&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://www.EWhisper.cn/images/dynatrace_docker_1.png"&gt;&lt;/p&gt;
&lt;h4&gt;示例&lt;/h4&gt;
&lt;p&gt;以下示例假定您已经运行&lt;code&gt;dynatrace/agent&lt;/code&gt; Docker容器, 通过名字 &lt;code&gt;dtagent&lt;/code&gt; 导入到&lt;code&gt;/dynatrace&lt;/code&gt;安装目录作为一个卷. GitHub上的&lt;a href="https://github.com/Dynatrace/Dynatrace-AppMon-Docker"&gt;AppMon in Docker&lt;/a&gt; 项目包含脚本来完成这个任务，甚至允许你在docker中方便地设置一个完整的appmon环境。更多的信息可以在以下的"性能诊所"(视频)找到。&lt;/p&gt;
&lt;h5&gt;示例: Apache Tomcat&lt;/h5&gt;
&lt;p&gt;下边的&lt;code&gt;docker-compose.yml&lt;/code&gt; 挂载容器&lt;code&gt;dtagent&lt;/code&gt; 导入的卷, 并且使用合适的&lt;code&gt;-agentpath&lt;/code&gt;来初始化&lt;code&gt;CATALINA_OPTS&lt;/code&gt;环境变量.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;tomcat&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="nt"&gt;image&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;tomcat&lt;/span&gt;
  &lt;span class="nt"&gt;ports&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;8080&lt;/span&gt;
  &lt;span class="nt"&gt;volumes_from&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;dtagent&lt;/span&gt;
  &lt;span class="nt"&gt;environment&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nt"&gt;CATALINA_OPTS&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;-agentpath:/dynatrace/agent/lib64/libdtagent.so=name=tomcat,collector=127.0.0.1:9998&amp;quot;&lt;/span&gt;
  &lt;span class="nt"&gt;command&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;catalina.sh run&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h5&gt;示例: NGINX&lt;/h5&gt;
&lt;blockquote&gt;
&lt;p&gt;待补充&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;分析&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;: 这种方法有助于巧妙地清晰地分离关注点，这是Docker世界的设计原则。此外，您不需要将agent放入您的基本映像中。在运行时进行一个简单的配置就可以监控您需要的容器的一切。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;缺点&lt;/strong&gt;: 虽然Docker运行时对容器之间交换volumes有很大的支持，但在容器编排平台（如kubernetes或openshift）上这样做会使您的应用程序配置过于复杂。&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="_2"&gt;基于继承的方案&lt;a class="headerlink" href="#_2" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;注意:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;不建议使用此方法，仅在此处进行演示。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;从技术角度而言，Docker化应用程序通常涉及两个部分：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一个基本镜像, 如:&lt;code&gt;java:8&lt;/code&gt;或&lt;code&gt;node:7&lt;/code&gt;, 提供基础的执行环境&lt;/li&gt;
&lt;li&gt;一个&lt;code&gt;Dockerfile&lt;/code&gt;, 用特定于应用程序的安装指令来扩充选定的基本镜像。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;使用你的&lt;code&gt;Dockerfile&lt;/code&gt;, 运行&lt;code&gt;docker build&lt;/code&gt;命令来创建需要的Docker 镜像.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://hub.docker.com/"&gt;Docker Hub&lt;/a&gt;上提供了一整套的基础镜像. 你可以阅读&lt;a href="https://www.digitalocean.com/community/tutorials/docker-explained-using-dockerfiles-to-automate-building-of-images"&gt;使用Dockerfiles自动化镜像构建&lt;/a&gt;和&lt;a href="https://docs.docker.com/articles/dockerfile_best-practices/"&gt;写Dockerfiles的最佳实践&lt;/a&gt;获取更多信息.&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://www.EWhisper.cn/images/dynatrace_docker_2.png"&gt;&lt;/p&gt;
&lt;h4&gt;示例&lt;/h4&gt;
&lt;p&gt;你可以为准备监控的应用创建基础镜像. 把agent打包为基础的自动启用监控的镜像。&lt;/p&gt;
&lt;p&gt;&lt;img alt="" src="https://www.EWhisper.cn/images/dynatrace_docker_3.png"&gt;&lt;/p&gt;
&lt;h5&gt;示例: Java&lt;/h5&gt;
&lt;p&gt;本例子展示了一个&lt;code&gt;Dockerfile&lt;/code&gt;, 来扩展官方的&lt;a href="https://github.com/docker-library/openjdk"&gt;openJDK Docker镜像&lt;/a&gt; 基础镜像, 并下载对应的agent. 为了遍历, 需要设置一些环境变量, 如&lt;code&gt;DT_AGENT_NAME&lt;/code&gt;和&lt;code&gt;DT_AGENT_COLLECTOR&lt;/code&gt;, 以后可以在这些变量中填入你自己的数据. 另外, &lt;code&gt;JAVA_OPTS&lt;/code&gt;添加一个指向&lt;code&gt;DT_AGENT_LIB64&lt;/code&gt;的&lt;code&gt;-agentpath&lt;/code&gt;参数.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;FROM&lt;/span&gt;&lt;span class="s"&gt; openjdk:8&lt;/span&gt;

&lt;span class="k"&gt;ENV&lt;/span&gt; DT_AGENT_INSTALLER_URL &lt;span class="s2"&gt;&amp;quot;http://files.dynatrace.com/downloads/OnPrem/dynaTrace/6.5/6.5.0.1289/dynatrace-agent-6.5.0.1289-unix.jar&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;ENV&lt;/span&gt; DT                     &lt;span class="s2"&gt;&amp;quot;/dynatrace&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;ENV&lt;/span&gt; DT_AGENT_LIB32         &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;/agent/lib/libdtagent.so&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;ENV&lt;/span&gt; DT_AGENT_LIB64         &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;/agent/lib64/libdtagent.so&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;ENV&lt;/span&gt; DT_AGENT_NAME          &lt;span class="s2"&gt;&amp;quot;java&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;ENV&lt;/span&gt; DT_AGENT_COLLECTOR     &lt;span class="s2"&gt;&amp;quot;127.0.0.1:9998&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;ENV&lt;/span&gt; JAVA_OPTS              &lt;span class="s2"&gt;&amp;quot;-agentpath:&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_AGENT_LIB64&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;=name=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_AGENT_NAME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;,collector=&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_AGENT_COLLECTOR&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;

&lt;span class="c"&gt;# Install the Agent&lt;/span&gt;
&lt;span class="k"&gt;RUN&lt;/span&gt; curl -L -o /tmp/&lt;span class="sb"&gt;`&lt;/span&gt;basename &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_AGENT_INSTALLER_URL&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt; &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_AGENT_INSTALLER_URL&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    java -jar /tmp/&lt;span class="sb"&gt;`&lt;/span&gt;basename &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_AGENT_INSTALLER_URL&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt; -t &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    rm -f /tmp/&lt;span class="sb"&gt;`&lt;/span&gt;basename &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;DT_AGENT_INSTALLER_URL&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="sb"&gt;`&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;构建该Dockerfile使用&lt;code&gt;docker build . -t openjdk:8-dtappmon -f ./Dockerfile&lt;/code&gt;在本地Docker仓库创建一个新的Docker镜像, 名字为&lt;code&gt;openjdk&lt;/code&gt;, 标签为&lt;code&gt;8-dtappmon&lt;/code&gt;. 每个应用构建, 你可以通过扩展&lt;code&gt;openjdk:8-dtappmon&lt;/code&gt;来创建应用镜像(如下所示, &lt;code&gt;repo.internal&lt;/code&gt;指的是虚拟仓库, &lt;code&gt;my-app&lt;/code&gt;是虚拟应用.) 你也可以覆盖&lt;code&gt;DT_AGENT_NAME&lt;/code&gt;环境变量来在该镜像里更准确的配置.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;FROM&lt;/span&gt;&lt;span class="s"&gt; openjdk:8-dtappmon&lt;/span&gt;

&lt;span class="k"&gt;ENV&lt;/span&gt; DT_AGENT_NAME &lt;span class="s2"&gt;&amp;quot;my-app&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;ADD&lt;/span&gt; https://repo.internal/my-app/builds/latest.tar.gz /app

&lt;span class="k"&gt;CMD&lt;/span&gt; java &lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;JAVA_OPTS&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt; -jar /app/my-app.jar
&lt;/pre&gt;&lt;/div&gt;


&lt;h5&gt;示例: Nginx&lt;/h5&gt;
&lt;blockquote&gt;
&lt;p&gt;待补充&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;分析&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;: 一旦agent已经被放入你的Docker基础映像中，在哪个容器平台上运行你的应用程序并不重要. 此外，这种方案减少了appmon整合的准备工作，不会增加频繁building，shipping和running Dockerized 应用程序过程的任何开销。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;缺点&lt;/strong&gt;: 根据您的特定用例和您所使用的技术,您必须手动集成这些技术. 因为这个方案会在特定技术的基础镜像上, 与特定技术的agent(如Java agent)紧密绑定, 当切换到另一种技术或appmon的新版本时，这些基本镜像可能需要被全部重新创建. (其实这个不算什么大问题, 就是定期更新agent)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="qa"&gt;Q&amp;amp;A&lt;a class="headerlink" href="#qa" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;h4&gt;我能监控运行在docker, alpine上的程序么?&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;待补充&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;我能监控在kubernetes或OpenShift上单 docker化应用么?&lt;/h4&gt;
&lt;p&gt;是的. 参见下一章节.&lt;/p&gt;
&lt;h4&gt;我能在docker中运行easyTravel(AppMon的demo程序)么?&lt;/h4&gt;
&lt;p&gt;EasyTravel已经在GitHub的&lt;a href="https://github.com/dynatrace/Dynatrace-easytravel-docker"&gt;EasyTravel in Docker &lt;/a&gt;完全实现容器化了. 你可以使用&lt;a href="https://github.com/Dynatrace/Dynatrace-AppMon-Docker"&gt;Dynatrace in Docker&lt;/a&gt;项目来注入监控.&lt;/p&gt;
&lt;h2 id="appmon-dockerized-apps-kubernetes-openshift"&gt;使用AppMon 监控 dockerized apps - Kubernetes 和 OpenShift&lt;a class="headerlink" href="#appmon-dockerized-apps-kubernetes-openshift" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;上一章描述了如何使用&lt;a href="https://www.dynatrace.com/solutions/application-monitoring/"&gt;AppMon&lt;/a&gt;监控 普通的Docker环境中的Dockerized apps.&lt;/p&gt;
&lt;p&gt;本章阐述了如何监控在&lt;a href="http://kubernetes.io/"&gt;Kubernetes&lt;/a&gt;和&lt;a href="https://www.openshift.com/"&gt;Red Hat OpenShift(v3)&lt;/a&gt;的 Dockerized 应用. (OpenShift算是Kubernetes的商业化).&lt;/p&gt;
&lt;p&gt;如上章"如何使用AppMon监控dockerized apps"所述, 根据于你的实际情况,  你可能会发现下列的方案更适合. 每种方案的利弊都已列出.&lt;/p&gt;
&lt;h3 id="a"&gt;方案A: 基于继承的方案&lt;a class="headerlink" href="#a" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;基于继承的方案的目标是把AppMon的agent放到你的Docker基础镜像里. 因为Kubernetes和OpenShift都是容器平台, 这种方案允许你来在这些平台上复用你的启用监控的镜像. 然而, 因为OpenShift是一个安全加固的容器平台, 使用root运行容器和执行进程(大部分Docker都是这么构建的)默认会被禁止.  参考&lt;a href="https://docs.openshift.org/latest/creating_images/guidelines.html"&gt;OpenShift 容器镜像向导&lt;/a&gt;来学习如何为OpenShift准备你的Docker镜像. 参见&lt;a href="https://www.dynatrace.com/support/doc/appmon/application-monitoring/monitor-specific-applications/monitor-docker-apps/monitor-dockerized-apps-with-appmon/"&gt;如何使用AppMon监控dockerized apps&lt;/a&gt;获取如何应用本方案到你的Docker镜像.&lt;/p&gt;
&lt;h4&gt;示例: Java&lt;/h4&gt;
&lt;p&gt;因为在你的基础镜像中的特定技术已被appmon监控，因此只需简单的运行时配置设置即可将agent绑定到appmon collector。&lt;/p&gt;
&lt;p&gt;下列例子为一个运行在&lt;a href="http://kubernetes.io/docs/user-guide/pods/"&gt;Pod&lt;/a&gt;上的一个叫做&lt;em&gt;catalog&lt;/em&gt;的容器定义了一个&lt;a href="http://kubernetes.io/docs/user-guide/replication-controller/"&gt;ReplicationController&lt;/a&gt;. 环境变量&lt;code&gt;DT_AGENT_NAME&lt;/code&gt;和&lt;code&gt;DT_AGENT_COLLECTOR&lt;/code&gt;(&lt;a href="https://www.dynatrace.com/support/doc/appmon/application-monitoring/monitor-specific-applications/monitor-docker-apps/monitor-dockerized-apps-with-appmon/"&gt;如何使用AppMon监控dockerized apps&lt;/a&gt;中已定义好)覆盖掉由基础的&lt;code&gt;acmeco/my-app&lt;/code&gt;镜像提供的各自的对应值.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;apiVersion&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;v1&lt;/span&gt;
&lt;span class="nt"&gt;kind&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;ReplicationController&lt;/span&gt;
&lt;span class="nt"&gt;metadata&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;my-app&lt;/span&gt;
&lt;span class="nt"&gt;spec&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
  &lt;span class="nt"&gt;template&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="nt"&gt;spec&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
      &lt;span class="nt"&gt;containers&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
      &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;my-app&lt;/span&gt;
        &lt;span class="nt"&gt;image&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;acmeco/my-app&lt;/span&gt;
        &lt;span class="nt"&gt;env&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;DT_AGENT_NAME&lt;/span&gt;
          &lt;span class="nt"&gt;value&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;my-app&amp;quot;&lt;/span&gt;
        &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;name&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;DT_AGENT_COLLECTOR&lt;/span&gt;
          &lt;span class="nt"&gt;value&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;dtappmon-collector.acmeco.com:9998&amp;quot;&lt;/span&gt;
        &lt;span class="nt"&gt;ports&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="p p-Indicator"&gt;-&lt;/span&gt; &lt;span class="nt"&gt;containerPort&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="l l-Scalar l-Scalar-Plain"&gt;8080&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;示例: Nginx&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;待补充&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;分析&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;优点&lt;/strong&gt;: 一旦agent已经被放入你的Docker基础映像中，在哪个容器平台上运行你的应用程序并不重要. 此外，这种方案减少了appmon整合的准备工作，不会增加频繁building，shipping和running Dockerized 应用程序过程的任何开销。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;缺点&lt;/strong&gt;: 根据您的特定用例和您所使用的技术,您必须手动集成这些技术. 因为这个方案会在特定技术的基础镜像上, 与特定技术的agent(如Java agent)紧密绑定, 当切换到另一种技术或appmon的新版本时，这些基本镜像可能需要被全部重新创建. (其实这个不算什么大问题, 就是定期更新agent)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="b"&gt;B方案: 基于组合的方案&lt;a class="headerlink" href="#b" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;待补充.&lt;/p&gt;
&lt;/blockquote&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">东风微鸣</dc:creator><pubDate>Tue, 12 Mar 2019 10:58:00 +0800</pubDate><guid isPermaLink="false">tag:www.ewhisper.cn,2019-03-12:/monitoring-docker-app-with-dynatrace.html</guid><category>APM</category><category>Dynatrace</category><category>docker</category></item></channel></rss>