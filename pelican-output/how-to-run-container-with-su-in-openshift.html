
<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.EWhisper.cn/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.EWhisper.cn/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.EWhisper.cn/theme/font-awesome/css/font-awesome.min.css">

    <link href="https://www.EWhisper.cn/static/custom.css" rel="stylesheet">


    <link href="https://www.EWhisper.cn/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="ä¸ªäººæŠ€æœ¯åˆ†äº« RSS">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">


    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="ä¸œé£å¾®é¸£" />
<meta name="description" content="è¿‘æœŸåœ¨å°è¯• office æ–‡æ¡£åœ¨çº¿ç¼–è¾‘å’Œé¢„è§ˆçš„ä¸€äº›è§£å†³æ–¹æ¡ˆ, ç›®å‰åœ¨ä½¿ç”¨Collabora Office, ä½†æ˜¯åœ¨OpenShiftä¸­è¿è¡Œä¸èµ·æ¥, å¿«çœ‹çœ‹æ˜¯æ€ä¹ˆè§£å†³çš„å§." />
<meta name="keywords" content="k8s, openshift, containers, å®‰å…¨">

<meta property="og:site_name" content="ä¸ªäººæŠ€æœ¯åˆ†äº«"/>
<meta property="og:title" content="å¦‚ä½•åœ¨ OpenShift ä¸­è¿è¡Œ Collabora Office"/>
<meta property="og:description" content="è¿‘æœŸåœ¨å°è¯• office æ–‡æ¡£åœ¨çº¿ç¼–è¾‘å’Œé¢„è§ˆçš„ä¸€äº›è§£å†³æ–¹æ¡ˆ, ç›®å‰åœ¨ä½¿ç”¨Collabora Office, ä½†æ˜¯åœ¨OpenShiftä¸­è¿è¡Œä¸èµ·æ¥, å¿«çœ‹çœ‹æ˜¯æ€ä¹ˆè§£å†³çš„å§."/>
<meta property="og:locale" content="zh_CN"/>
<meta property="og:url" content="https://www.EWhisper.cn/how-to-run-container-with-su-in-openshift.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-10-03 18:00:00+08:00"/>
<meta property="article:modified_time" content="2019-10-03 20:00:00+08:00"/>
<meta property="article:author" content="https://www.EWhisper.cn/author/dong-feng-wei-ming.html">
<meta property="article:section" content="DevOps"/>
<meta property="article:tag" content="k8s"/>
<meta property="article:tag" content="openshift"/>
<meta property="article:tag" content="containers"/>
<meta property="article:tag" content="å®‰å…¨"/>
<meta property="og:image" content="//s.gravatar.com/avatar/7c743bc6ac83171e35a5aa8bd66cc1ea?s=120">

  <title>ä¸ªäººæŠ€æœ¯åˆ†äº« &ndash; å¦‚ä½•åœ¨ OpenShift ä¸­è¿è¡Œ Collabora Office</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://www.EWhisper.cn">
        <img src="//s.gravatar.com/avatar/7c743bc6ac83171e35a5aa8bd66cc1ea?s=120" alt="ä¸ªäººæŠ€æœ¯åˆ†äº«" title="ä¸ªäººæŠ€æœ¯åˆ†äº«">
      </a>
      <h1><a href="https://www.EWhisper.cn">ä¸ªäººæŠ€æœ¯åˆ†äº«</a></h1>

<p>Focus on Python/Java/DevOps/Observability</p>
      <nav>
        <ul class="list">
          <li><a href="https://www.EWhisper.cn/pages/about.html#about">About</a></li>
          <li><a href="https://www.EWhisper.cn/pages/contact.html#contact">Contact</a></li>

          <li><a href="http://beian.miit.gov.cn" target="_blank">æ²ªICPå¤‡19007314å·-1</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-wechat" href="/images/wechat_paycode.png" target="_blank"><i class="fa fa-wechat"></i></a></li>
        <li><a class="sc-envelope-o" href="mailto:cuikaidong@foxmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-reddit" href="https://www.jianshu.com/u/0f08daeaa5a9" target="_blank"><i class="fa fa-reddit"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/å‡¯ä¸œ-å´”-136128116/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-weibo" href="https://weibo.com/long5to2gf" target="_blank"><i class="fa fa-weibo"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://www.EWhisper.cn">ä¸»é¡µ</a>

      <a href="/archives/index.html">å­˜æ¡£</a>
      <a href="/categories.html">ç±»åˆ«</a>
      <a href="/tags.html">æ ‡ç­¾</a>
      <a href="/authors.html">ä½œè€…</a>


      <a href="https://www.EWhisper.cn/feeds/all.rss.xml">RSSè®¢é˜…</a>
    </nav>

<article class="single">
  <header>
    <h1 id="how-to-run-container-with-su-in-openshift">å¦‚ä½•åœ¨ OpenShift ä¸­è¿è¡Œ Collabora Office</h1>
    <p>
      åœ¨ 2019-10-03 Thursday å‘å¸ƒäº <a href="https://www.EWhisper.cn/category/devops.html">DevOps</a> åˆ†ç±»

        &#8226; 3 min read
    </p>
  </header>


  <div>
    <div class="toc">
<ul>
<li><a href="#_1">å‰è¨€</a><ul>
<li><a href="#collabora-office">Collabora Office ç®€ä»‹</a></li>
</ul>
</li>
<li><a href="#-">åˆ†æ - éœ€è¦å“ªäº›ç‰¹æƒ</a><ul>
<li><a href="#_2">éœ€è¦çš„ç‰¹æƒ</a></li>
</ul>
</li>
<li><a href="#_3">è§£å†³æ–¹æ¡ˆ</a><ul>
<li><a href="#openshift-root">åœ¨ OpenShift ä¸­å¯ç”¨å®¹å™¨çš„ ROOT</a></li>
<li><a href="#openshift-capabilities">åœ¨ OpenShift ä¸­ä¸ºå®¹å™¨æä¾›å…¶ä»– Capabilities</a></li>
</ul>
</li>
<li><a href="#_4">æ€»ç»“</a></li>
</ul>
</div>
<h2 id="_1">å‰è¨€<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>è¿‘æœŸåœ¨å°è¯• office æ–‡æ¡£åœ¨çº¿ç¼–è¾‘å’Œé¢„è§ˆçš„ä¸€äº›è§£å†³æ–¹æ¡ˆ, ç›®å‰åœ¨ä½¿ç”¨Collabora Office, ä½†æ˜¯<a href="https://hub.docker.com/r/collabora/code">Collaboraçš„dockeré•œåƒ</a>åœ¨OpenShiftä¸­è¿è¡Œä¸èµ·æ¥, ä¸€ç›´æç¤º<code>Operation not permitted</code>.</p>
<h3 id="collabora-office">Collabora Office ç®€ä»‹<a class="headerlink" href="#collabora-office" title="Permanent link">&para;</a></h3>
<p><a href="https://www.collaboraoffice.com/">Collabora Office</a> æä¾›å¼ºå¤§çš„Office å¥—ä»¶, ä½¿æ‚¨èƒ½å¤Ÿè®¿é—®æ–‡æ¡£ã€ç¼–å†™æ–°å†…å®¹å¹¶ååŒå·¥ä½œã€‚</p>
<p><img alt="Collabora Office" src="./images/Collabora-Office.png"></p>
<ul>
<li>å¯ä»¥åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šå®‰è£…å¥—ä»¶</li>
<li>å¯ä»¥å’Œå…¶ä»–åº”ç”¨ï¼ˆå¦‚ï¼šnextcloud owncloudç­‰ï¼‰æˆ–ä½ è‡ªå·±çš„åº”ç”¨è¿›è¡Œæ•´åˆ</li>
<li>i18nçº§åˆ«çš„å…¼å®¹æ€§</li>
<li>ååŒç¼–è¾‘</li>
<li>å¯ä»¥å®Œç¾èå…¥è¿›è‡ªå·±çš„è§£å†³æ–¹æ¡ˆ</li>
</ul>
<h2 id="-">åˆ†æ - éœ€è¦å“ªäº›ç‰¹æƒ<a class="headerlink" href="#-" title="Permanent link">&para;</a></h2>
<p><a href="https://hub.docker.com/r/collabora/code">Collaboraçš„dockeré•œåƒ</a>åœ¨OpenShiftä¸­è¿è¡Œä¸èµ·æ¥, ä¸€ç›´æç¤º<code>Operation not permitted</code>. å…¶å®åŸå› æƒé™ä¸å…è®¸, å®ƒéœ€è¦åšçš„ä¸€äº›æ“ä½œåœ¨OpenShiftä¸­æ˜¯è¢«ç¦æ­¢çš„(å‡ºäºä¼ä¸šçº§å®‰å…¨çš„è€ƒè™‘). æ‰€ä»¥æˆ‘ä»¬å°†å®ƒéœ€è¦çš„æƒé™ä¸€é¡¹ä¸€é¡¹åŠ ä¸Šå°±å¥½äº†.</p>
<p>è¦ææ¸…æ¥šå®ƒéœ€è¦å“ªäº›æƒé™, æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å®ƒçš„<a href="https://github.com/CollaboraOnline/Docker-CODE"><code>Dockerfile</code></a>åŠå…¶ç›¸å…³å†…å®¹:</p>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> ubuntu:16.04</span>

<span class="c"># Environment variables</span>
<span class="k">ENV</span> domain localhost
<span class="k">ENV</span> LC_CTYPE en_US.UTF-8

<span class="c"># Setup scripts for LibreOffice Online</span>
<span class="k">ADD</span> /scripts/install-libreoffice.sh /
<span class="k">ADD</span> /scripts/start-libreoffice.sh /
<span class="k">RUN</span> bash install-libreoffice.sh

<span class="k">EXPOSE</span><span class="s"> 9980</span>

<span class="c"># Entry point</span>
<span class="k">CMD</span> bash start-libreoffice.sh
</pre></div>


<p><code>dockerfile</code>ä¸­å¦‚ä¸Šæ‰€ç¤º, è¿™ä¸ªæ–‡ä»¶è™½ç„¶ç®€å•, ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å¾—åˆ°2ä¸ªä¿¡æ¯:</p>
<ol>
<li>æ²¡æœ‰<code>USER</code> æŒ‡ä»¤, é‚£ä¹ˆè¿™ä¸ªé•œåƒå¯èƒ½æ˜¯éœ€è¦<code>root</code>æƒé™æ‰èƒ½è¿è¡Œçš„.</li>
<li>åŠ å…¥äº†2ä¸ªè„šæœ¬. å…¶ä¸­ <code>start-libreoffice.sh</code>æ˜¯åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™è¿è¡Œçš„, æ‰€ä»¥ä¸»è¦æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè„šæœ¬çš„å†…å®¹:</li>
</ol>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># Fix domain name resolution from jails</span>
cp /etc/resolv.conf /etc/hosts /opt/lool/systemplate/etc/

<span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">DONT_GEN_SSL_CERT</span><span class="p">-set</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> set<span class="p">;</span> <span class="k">then</span>
<span class="c1"># Generate new SSL certificate instead of using the default</span>
mkdir -p /opt/ssl/
<span class="nb">cd</span> /opt/ssl/
mkdir -p certs/ca
openssl genrsa -out certs/ca/root.key.pem <span class="m">2048</span>
openssl req -x509 -new -nodes -key certs/ca/root.key.pem -days <span class="m">9131</span> -out certs/ca/root.crt.pem -subj <span class="s2">&quot;/C=DE/ST=BW/L=Stuttgart/O=Dummy Authority/CN=Dummy Authority&quot;</span>
mkdir -p certs/<span class="o">{</span>servers,tmp<span class="o">}</span>
mkdir -p <span class="s2">&quot;certs/servers/localhost&quot;</span>
openssl genrsa -out <span class="s2">&quot;certs/servers/localhost/privkey.pem&quot;</span> <span class="m">2048</span> -key <span class="s2">&quot;certs/servers/localhost/privkey.pem&quot;</span>
<span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">cert_domain</span><span class="p">-set</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">==</span> set<span class="p">;</span> <span class="k">then</span>
openssl req -key <span class="s2">&quot;certs/servers/localhost/privkey.pem&quot;</span> -new -sha256 -out <span class="s2">&quot;certs/tmp/localhost.csr.pem&quot;</span> -subj <span class="s2">&quot;/C=DE/ST=BW/L=Stuttgart/O=Dummy Authority/CN=localhost&quot;</span>
<span class="k">else</span>
openssl req -key <span class="s2">&quot;certs/servers/localhost/privkey.pem&quot;</span> -new -sha256 -out <span class="s2">&quot;certs/tmp/localhost.csr.pem&quot;</span> -subj <span class="s2">&quot;/C=DE/ST=BW/L=Stuttgart/O=Dummy Authority/CN=</span><span class="si">${</span><span class="nv">cert_domain</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">fi</span>
openssl x509 -req -in certs/tmp/localhost.csr.pem -CA certs/ca/root.crt.pem -CAkey certs/ca/root.key.pem -CAcreateserial -out certs/servers/localhost/cert.pem -days <span class="m">9131</span>
mv certs/servers/localhost/privkey.pem /etc/loolwsd/key.pem
mv certs/servers/localhost/cert.pem /etc/loolwsd/cert.pem
mv certs/ca/root.crt.pem /etc/loolwsd/ca-chain.cert.pem
<span class="k">fi</span>

<span class="c1"># Replace trusted host and set admin username and password</span>
perl -pi -e <span class="s2">&quot;s/localhost&lt;\/host&gt;/</span><span class="si">${</span><span class="nv">domain</span><span class="si">}</span><span class="s2">&lt;\/host&gt;/g&quot;</span> /etc/loolwsd/loolwsd.xml
perl -pi -e <span class="s2">&quot;s/&lt;username (.*)&gt;.*&lt;\/username&gt;/&lt;username \1&gt;</span><span class="si">${</span><span class="nv">username</span><span class="si">}</span><span class="s2">&lt;\/username&gt;/&quot;</span> /etc/loolwsd/loolwsd.xml
perl -pi -e <span class="s2">&quot;s/&lt;password (.*)&gt;.*&lt;\/password&gt;/&lt;password \1&gt;</span><span class="si">${</span><span class="nv">password</span><span class="si">}</span><span class="s2">&lt;\/password&gt;/&quot;</span> /etc/loolwsd/loolwsd.xml
perl -pi -e <span class="s2">&quot;s/&lt;server_name (.*)&gt;.*&lt;\/server_name&gt;/&lt;server_name \1&gt;</span><span class="si">${</span><span class="nv">server_name</span><span class="si">}</span><span class="s2">&lt;\/server_name&gt;/&quot;</span> /etc/loolwsd/loolwsd.xml
perl -pi -e <span class="s2">&quot;s/&lt;allowed_languages (.*)&gt;.*&lt;\/allowed_languages&gt;/&lt;allowed_languages \1&gt;</span><span class="si">${</span><span class="nv">dictionaries</span><span class="k">:-</span><span class="nv">de_DE</span><span class="p"> en_GB en_US es_ES fr_FR it nl pt_BR pt_PT ru</span><span class="si">}</span><span class="s2">&lt;\/allowed_languages&gt;/&quot;</span> /etc/loolwsd/loolwsd.xml

<span class="c1"># Restart when /etc/loolwsd/loolwsd.xml changes</span>
<span class="o">[</span> -x /usr/bin/inotifywait -a /usr/bin/killall <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">(</span>
    /usr/bin/inotifywait -e modify /etc/loolwsd/loolwsd.xml
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="k">$(</span>ls -l /etc/loolwsd/loolwsd.xml<span class="k">)</span><span class="s2"> modified --&gt; restarting&quot;</span>
    /usr/bin/killall -1 loolwsd
<span class="o">)</span> <span class="p">&amp;</span>

<span class="c1"># Start loolwsd</span>
su -c <span class="s2">&quot;/usr/bin/loolwsd --version --o:sys_template_path=/opt/lool/systemplate --o:lo_template_path=/opt/collaboraoffice6.0 --o:child_root_path=/opt/lool/child-roots --o:file_server_root_path=/usr/share/loolwsd </span><span class="si">${</span><span class="nv">extra_params</span><span class="si">}</span><span class="s2">&quot;</span> -s /bin/bash lool
</pre></div>


<p>ä»”ç»†åˆ†æä¸‹è„šæœ¬:</p>
<ol>
<li>ç¬¬ä¸€å¥<code>cp /etc/resolv.conf /etc/hosts /opt/lool/systemplate/etc/</code> å¾ˆæ˜æ˜¾å°±æ˜¯éœ€è¦<code>root</code>æƒé™çš„.</li>
<li>ä¹‹åä¼šè¿›è¡Œç”Ÿæˆè¯ä¹¦çš„æ“ä½œ</li>
<li>ç„¶åä¼šè¿›è¡Œç›¸å…³çš„å˜é‡æ›¿æ¢æ“ä½œ</li>
<li>æ¥ä¸‹æ¥æ˜¯å½“<code>/etc/loolwsd/loolwsd.xml</code>è¿™ä¸ªé…ç½®æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œé‡å¯, æ³¨æ„è¿™è¾¹åˆæ¥äº†å¥½å‡ ä¸ªç‰¹æƒæ“ä½œ:<ol>
<li><code>/usr/bin/inotifywait</code></li>
<li><code>/usr/bin/killall</code></li>
</ol>
</li>
<li>å¯åŠ¨<code>loolwsd</code> åˆæ˜¯ä¸€ä¸ªç‰¹æƒæ“ä½œ: <code>su -c</code></li>
</ol>
<h3 id="_2">éœ€è¦çš„ç‰¹æƒ<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>åˆæ­¥æ€»ç»“ä¸€ä¸‹éœ€è¦çš„ç‰¹æƒ:</p>
<ul>
<li><code>root</code> ç”¨æˆ·</li>
<li><code>inotifywait</code></li>
<li><code>killall</code></li>
<li><code>su -c</code></li>
</ul>
<h2 id="_3">è§£å†³æ–¹æ¡ˆ<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="openshift-root">åœ¨ OpenShift ä¸­å¯ç”¨å®¹å™¨çš„ ROOT<a class="headerlink" href="#openshift-root" title="Permanent link">&para;</a></h3>
<blockquote>
<p><img align="absmiddle" alt="ğŸ““" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4d3.png" title=":notebook:" width="20px"> å¤‡æ³¨:</p>
<p><a href="https://docs.openshift.com/container-platform/3.9/admin_guide/manage_scc.html#enable-dockerhub-images-that-require-root">å®˜æ–¹OpenShiftæ–‡æ¡£: Enable Container Images that Require Root</a></p>
<p>è¿™é‡Œå°±ä¸è¯¦ç»†çš„ä¸€æ­¥æ­¥ä»‹ç»äº†, å…·ä½“æ­¥éª¤å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« : <a href="https://www.EWhisper.cn/deploy-app-with-openshift-in-enterprise-env.html">OpenShiftä¼ä¸šæµ‹è¯•ç¯å¢ƒåº”ç”¨éƒ¨ç½²å®æˆ˜</a></p>
</blockquote>
<p>æœ‰äº›å®¹å™¨é•œåƒ(å¦‚: <code>postgres</code>å’Œ<code>redis</code>å’Œè¿™æ¬¡çš„<code>collabora</code>)éœ€è¦rootæƒé™, å¹¶ä¸”å¯¹å·å±äºè°æœ‰æ˜ç¡®æœŸæœ›. å¯¹äºè¿™ç±»é•œåƒ, éœ€è¦ç»™å…¶å¯¹åº”çš„service account(æœåŠ¡è´¦æˆ·, ä¸€ç§ç‰¹æ®Šè´¦æˆ·, ç”¨äºç³»ç»Ÿæ‰§è¡ŒæŸäº›æ“ä½œ)åŠ ä¸Š<code>anyuid</code> SCC(Security Context Constraints: å®‰å…¨ä¸Šä¸‹æ–‡çº¦æŸ):</p>
<p><code>oc adm policy add-scc-to-user anyuid system:serviceaccount:myproject:mysvcacct</code></p>
<h3 id="openshift-capabilities">åœ¨ OpenShift ä¸­ä¸ºå®¹å™¨æä¾›å…¶ä»– Capabilities<a class="headerlink" href="#openshift-capabilities" title="Permanent link">&para;</a></h3>
<blockquote>
<p><img align="absmiddle" alt="ğŸ““" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4d3.png" title=":notebook:" width="20px"> å¤‡æ³¨:</p>
<p>ä»¥ä¸‹å†…å®¹æ¥è‡ª<a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities">Dockerå®˜æ–¹æ–‡æ¡£: Runtime privilege and Linux capabilities</a></p>
</blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒDockerå®¹å™¨æ˜¯â€œæ— ç‰¹æƒçš„â€(unprivileged)ï¼Œä¾‹å¦‚ï¼Œä¸èƒ½åœ¨Dockerå®¹å™¨å†…è¿è¡ŒDockerå®ˆæŠ¤è¿›ç¨‹ã€‚è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹å™¨ä¸å…è®¸è®¿é—®ä»»ä½•è®¾å¤‡ï¼Œä½†æ˜¯ä¸€ä¸ª"privileged"(â€œç‰¹æƒâ€)å®¹å™¨å¯ä»¥è®¿é—®æ‰€æœ‰è®¾å¤‡ã€‚</p>
<p>é™¤äº†"privileged"ä¹‹å¤–ï¼Œæ“ä½œå‘˜è¿˜å¯ä»¥ä½¿ç”¨<code>--cap-add</code>å’Œ<code>--cap-drop</code>å¯¹capabilities(åŠŸèƒ½)è¿›è¡Œç»†ç²’åº¦æ§åˆ¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒDockeræœ‰ä¸€ä¸ªä¿ç•™çš„é»˜è®¤capabilitiesåˆ—è¡¨ã€‚ä¸‹è¡¨åˆ—å‡ºäº†Linux capabilitiesé€‰é¡¹ï¼Œè¿™äº›é€‰é¡¹æ˜¯é»˜è®¤å…è®¸çš„ã€‚</p>
<table>
<thead>
<tr>
<th align="left">Capability Key</th>
<th align="left">ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">SETPCAP</td>
<td align="left">ä¿®æ”¹è¿›ç¨‹çš„ capabilities.</td>
</tr>
<tr>
<td align="left">MKNOD</td>
<td align="left">é€šè¿‡mknodåˆ›å»ºç‰¹æ®Š(å¦‚è®¾å¤‡)æ–‡ä»¶</td>
</tr>
<tr>
<td align="left">AUDIT_WRITE</td>
<td align="left">å°†è®°å½•å†™å…¥å†…æ ¸å®¡è®¡æ—¥å¿—ã€‚</td>
</tr>
<tr>
<td align="left">CHOWN</td>
<td align="left">ä»»æ„æ›´æ”¹æ–‡ä»¶UIDå’ŒGID</td>
</tr>
<tr>
<td align="left">NET_RAW</td>
<td align="left">ä½¿ç”¨RAW å’ŒPACKETçš„ sockets.</td>
</tr>
<tr>
<td align="left">DAC_OVERRIDE</td>
<td align="left">ç»•è¿‡æ–‡ä»¶çš„è¯»ã€å†™å’Œæ‰§è¡Œæƒé™æ£€æŸ¥ã€‚</td>
</tr>
<tr>
<td align="left">FOWNER</td>
<td align="left">Bypass permission checks on operations that normally require the file system UID of the process to match the UID of the file.å¯¹é€šå¸¸éœ€è¦è¿›ç¨‹çš„æ–‡ä»¶ç³»ç»ŸUIDä¸æ–‡ä»¶çš„UIDåŒ¹é…çš„æ“ä½œè¿›è¡Œç»•è¿‡æƒé™æ£€æŸ¥ã€‚</td>
</tr>
<tr>
<td align="left">FSETID</td>
<td align="left">Donâ€™t clear set-user-ID and set-group-ID permission bits when a file is modified.å½“æ–‡ä»¶è¢«ä¿®æ”¹æ—¶ï¼Œä¸æ¸…é™¤set-user-IDå’Œset-group-IDæƒé™ä½ã€‚</td>
</tr>
<tr>
<td align="left">KILL</td>
<td align="left">Bypass permission checks for sending signals.ç»•è¿‡å‘é€ä¿¡å·çš„æƒé™æ£€æŸ¥ã€‚</td>
</tr>
<tr>
<td align="left">SETGID</td>
<td align="left">å¯¹è¿›ç¨‹GIDè¿›è¡Œä»»æ„æ“ä½œ; å‘ç”¨æˆ·çš„å‘½åç©ºé—´ä¸­å†™å…¥GIDæ˜ å°„</td>
</tr>
<tr>
<td align="left">SETUID</td>
<td align="left">å¯¹è¿›ç¨‹UIDè¿›è¡Œä»»æ„æ“ä½œ; å‘ç”¨æˆ·çš„å‘½åç©ºé—´ä¸­å†™å…¥UIDæ˜ å°„</td>
</tr>
<tr>
<td align="left">NET_BIND_SERVICE</td>
<td align="left">ä¸ºä½äº1024ä»¥ä¸‹çš„ç«¯å£ç»‘å®šsockets</td>
</tr>
<tr>
<td align="left">SYS_CHROOT</td>
<td align="left">ä½¿ç”¨chroot, ä¿®æ”¹rootç›®å½•</td>
</tr>
<tr>
<td align="left">SETFCAP</td>
<td align="left">ä¸ºæ–‡ä»¶è®¾ç½®ä»»æ„çš„capabilities.</td>
</tr>
</tbody>
</table>
<p>ä¸‹è¡¨æ˜¾ç¤ºäº†é»˜è®¤æƒ…å†µä¸‹æœªæˆäºˆçš„åŠŸèƒ½ï¼Œå¯ä»¥æ·»åŠ è¿™äº›åŠŸèƒ½ã€‚</p>
<table>
<thead>
<tr>
<th align="left">Capability Key</th>
<th align="left">ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">SYS_MODULE</td>
<td align="left">åŠ è½½å’Œå¸è½½å†…æ ¸modules.</td>
</tr>
<tr>
<td align="left">SYS_RAWIO</td>
<td align="left">æ‰§è¡ŒI/O portæ“ä½œ(ioplå’Œioperm).</td>
</tr>
<tr>
<td align="left">SYS_PACCT</td>
<td align="left">ä½¿ç”¨ acct, å¼€å¯æˆ–å…³é—­è¿›ç¨‹accounting</td>
</tr>
<tr>
<td align="left">SYS_ADMIN</td>
<td align="left">Perform a range of system administration operations. æ‰§è¡Œä¸€ç³»åˆ—ç³»ç»Ÿç®¡ç†å‘˜æ“ä½œ</td>
</tr>
<tr>
<td align="left">SYS_NICE</td>
<td align="left">æé«˜è¿›ç¨‹çš„nice value(niceï¼Œ setpriorityï¼Œå¹¶æ”¹å˜ä»»æ„è¿›ç¨‹çš„nice valueã€‚</td>
</tr>
<tr>
<td align="left">SYS_RESOURCE</td>
<td align="left">è¦†ç›–èµ„æºæ•°é™åˆ¶</td>
</tr>
<tr>
<td align="left">SYS_TIME</td>
<td align="left">è®¾ç½®ç³»ç»Ÿæ—¶é’Ÿ (settimeofday, stime, adjtimex; è®¾ç½®real-time (ç¡¬ä»¶) clock.</td>
</tr>
<tr>
<td align="left">SYS_TTY_CONFIG</td>
<td align="left">ä½¿ç”¨vhangup ;åœ¨è™šæ‹Ÿç»ˆç«¯ä¸Šä½¿ç”¨å„ç§ç‰¹æƒioctlæ“ä½œã€‚</td>
</tr>
<tr>
<td align="left">AUDIT_CONTROL</td>
<td align="left">å¯ç”¨å’Œç¦ç”¨å†…æ ¸å®¡è®¡;æ›´æ”¹å®¡è®¡è¿‡æ»¤è§„åˆ™;æ£€ç´¢å®¡è®¡çŠ¶æ€å’Œè¿‡æ»¤è§„åˆ™ã€‚</td>
</tr>
<tr>
<td align="left">MAC_ADMIN</td>
<td align="left">Allow MAC configuration or state changes. Implemented for the Smack LSM.</td>
</tr>
<tr>
<td align="left">MAC_OVERRIDE</td>
<td align="left">Override Mandatory Access Control (MAC). Implemented for the Smack Linux Security Module (LSM).</td>
</tr>
<tr>
<td align="left">NET_ADMIN</td>
<td align="left">æ‰§è¡Œå„ç§ç½‘ç»œç›¸å…³çš„æ“ä½œ</td>
</tr>
<tr>
<td align="left">SYSLOG</td>
<td align="left">æ‰§è¡Œprivileged syslogæ“ä½œ.</td>
</tr>
<tr>
<td align="left">DAC_READ_SEARCH</td>
<td align="left">ç»•è¿‡æ–‡ä»¶è¯»æƒé™æ£€æŸ¥å’Œç›®å½•è¯»å’Œæ‰§è¡Œæƒé™æ£€æŸ¥ã€‚</td>
</tr>
<tr>
<td align="left">LINUX_IMMUTABLE</td>
<td align="left">Set the FS_APPEND_FL and FS_IMMUTABLE_FL i-node flags.</td>
</tr>
<tr>
<td align="left">NET_BROADCAST</td>
<td align="left">å¯ç”¨å¥—æ¥å­—å¹¿æ’­ï¼Œç›‘å¬å¤šæ’­ã€‚</td>
</tr>
<tr>
<td align="left">IPC_LOCK</td>
<td align="left">é”å†…å­˜ (mlock, mlockall, mmap, shmctl).</td>
</tr>
<tr>
<td align="left">IPC_OWNER</td>
<td align="left">å¯¹System V IPCå¯¹è±¡ä¸Šçš„æ“ä½œè¿›è¡Œç»•è¿‡æƒé™æ£€æŸ¥ã€‚</td>
</tr>
<tr>
<td align="left">SYS_PTRACE</td>
<td align="left">ä½¿ç”¨ptraceè·Ÿè¸ªä»»æ„è¿›ç¨‹ã€‚</td>
</tr>
<tr>
<td align="left">SYS_BOOT</td>
<td align="left">ä½¿ç”¨rebootå’Œkexec_loadï¼Œé‡æ–°å¯åŠ¨å¹¶åŠ è½½ä¸€ä¸ªæ–°çš„å†…æ ¸ä¾›ä»¥åæ‰§è¡Œã€‚</td>
</tr>
<tr>
<td align="left">LEASE</td>
<td align="left">å¯¹ä»»æ„æ–‡ä»¶å»ºç«‹ç§Ÿçº¦(å‚è§fcntl)ã€‚</td>
</tr>
<tr>
<td align="left">WAKE_ALARM</td>
<td align="left">è§¦å‘å”¤é†’ç³»ç»Ÿã€‚</td>
</tr>
<tr>
<td align="left">BLOCK_SUSPEND</td>
<td align="left">ä½¿ç”¨å¯ä»¥é˜»æ­¢ç³»ç»ŸæŒ‚èµ·çš„ç‰¹æ€§ã€‚</td>
</tr>
</tbody>
</table>
<p>æ›´å¤šå‚è€ƒèµ„æ–™è§: <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities(7) - Linux man page</a></p>
<blockquote>
<p><img align="absmiddle" alt="ğŸ““" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4d3.png" title=":notebook:" width="20px"> å¤‡æ³¨:</p>
<p>ä»¥ä¸‹å†…å®¹æ¥è‡ª<a href="https://docs.openshift.com/container-platform/3.9/admin_guide/manage_scc.html#provide-additional-capabilities">OpenShiftå®˜æ–¹æ–‡æ¡£: Provide Additional Capabilities</a></p>
</blockquote>
<p>æœ‰æ—¶å€™, é•œåƒä¼šéœ€è¦Dockeré»˜è®¤æ²¡æœ‰æä¾›çš„capabilities(åŠŸèƒ½). é‚£ä¹ˆä½ å¯ä»¥åœ¨podçš„æè¿°æ–‡ä»¶ specificationä¸­è¯·æ±‚è¿™äº›é¢å¤–çš„capabilities, è¿™äº›capabilitieså°†æ ¹æ®SCCè¿›è¡ŒéªŒè¯.</p>
<blockquote>
<p><img align="absmiddle" alt="â—" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/2757.png" title=":exclamation:" width="20px"> æ³¨æ„:</p>
<p>è¿™å…è®¸é•œåƒä»¥ææƒåçš„åŠŸèƒ½è¿è¡Œï¼Œ<strong>åº”è¯¥ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨</strong>ã€‚ä¸åº”ç¼–è¾‘é»˜è®¤çš„å—é™SCCä»¥å¯ç”¨å…¶ä»–åŠŸèƒ½ã€‚</p>
</blockquote>
<p>å½“ä¸éæ ¹ç”¨æˆ·ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œè¿˜å¿…é¡»ç¡®ä¿ä½¿ç”¨<code>setcap</code>å‘½ä»¤ä¸ºéœ€è¦é™„åŠ åŠŸèƒ½çš„æ–‡ä»¶æˆäºˆcapabilitiesã€‚ä¾‹å¦‚ï¼Œåœ¨é•œåƒçš„Dockerfileä¸­:</p>
<p><code>setcap cap_net_raw,cap_net_admin+p /usr/bin/ping</code></p>
<p>æ­¤å¤–ï¼Œå¦‚æœDockerä¸­é»˜è®¤æä¾›äº†åŠŸèƒ½ï¼Œåˆ™ä¸éœ€è¦ä¿®æ”¹pod specificationæ¥è¯·æ±‚å®ƒã€‚ä¾‹å¦‚ï¼Œ<code>NET_RAW</code>æ˜¯é»˜è®¤æä¾›çš„ï¼Œåº”è¯¥å·²ç»åœ¨pingä¸Šè®¾ç½®äº†æ­¤åŠŸèƒ½ï¼Œå› æ­¤è¿è¡Œpingä¸éœ€è¦ç‰¹æ®Šçš„æ­¥éª¤ã€‚</p>
<p>è¦æä¾›é¢å¤–çš„åŠŸèƒ½:</p>
<p>æä¾›é¢å¤–åŠŸèƒ½:</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„SCC</li>
<li>ä½¿ç”¨<code>allowedabilities</code>å­—æ®µæ·»åŠ å…è®¸çš„åŠŸèƒ½ã€‚</li>
<li>åˆ›å»ºpodæ—¶ï¼Œåœ¨<code>securityContext.capabilities.add</code>ä¸­æ·»åŠ è¯·æ±‚è¯¥åŠŸèƒ½çš„å­—æ®µã€‚</li>
</ol>
<h4>ä¸ºCollabora æä¾›éœ€è¦çš„Capabilities</h4>
<p>é’ˆå¯¹è¿™ä¸ªCollaboraé•œåƒ, ä»”ç»†åˆ†æå, è¦å¿«é€Ÿè§£å†³, å…¶å®åœ¨å®¹å™¨çš„specä¸­ç»™å®ƒæˆäºˆ"privileged" å°±å¯ä»¥äº†. <strong>æ³¨æ„: ä¹‹å‰å…³äºrootçš„æƒé™æ˜¯åœ¨<code>deployment</code>ä¸‹é…ç½®çš„. è¿™ä¸ªæ˜¯åœ¨<code>containers</code>ä¸‹é…ç½®çš„.</strong></p>
<p>å…·ä½“é…ç½®å¦‚ä¸‹:</p>
<p><img alt="container spec cap" src="./images/container_spec_scc.png"></p>
<p>è¯´æ˜å¦‚ä¸‹:</p>
<ul>
<li><code>allowPrivilegeEscalation: true</code> - å…è®¸æƒé™æå‡. å…¶å®å°±æ˜¯ç»™äº†è¿™ä¸ªå®¹å™¨"privileged".</li>
<li>ç”¨privilegedçš„sccï¼Œéœ€è¦ç›¸åº”çš„capabilities. æ‰€ä»¥åˆæ·»åŠ äº†<code>MKNOD</code>è¿™ä¸ªcapability.</li>
</ul>
<h2 id="_4">æ€»ç»“<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>åœ¨OpenShiftä¸­:</p>
<ol>
<li>å®¹å™¨éœ€è¦rootç”¨æˆ·, ç»™å®ƒå¯¹åº”çš„deploymentæ·»åŠ Service Account, å¹¶æ·»åŠ <code>anyuid</code>çš„SCC.</li>
<li>å®¹å™¨éœ€è¦å…¶ä»–capabilities, ç®€å•çš„æ–¹å¼å°±æ˜¯ç»™å®ƒ"privileged" è¿™ä¸ªç‰¹æƒ.</li>
</ol>
<p><em>æœ€åé¡ºä¾¿åæ§½ä¸€ä¸‹, SCCå’Œlinux capabilitieså®åœ¨æ˜¯å¤ªéš¾äº†, å¯¹å®‰å…¨ä¸€çŸ¥åŠè§£çš„æˆ‘ä¸€è„¸æ‡µé€¼. <img align="absmiddle" alt="ğŸ˜‚" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f602.png" title=":joy:" width="20px"><img align="absmiddle" alt="ğŸ˜‚" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f602.png" title=":joy:" width="20px"><img align="absmiddle" alt="ğŸ˜‚" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f602.png" title=":joy:" width="20px"></em> </p>
<p><img alt="å¤ªéš¾äº†" src="./images/too-hard.jpg"></p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.EWhisper.cn/tag/k8s.html">k8s</a>
      <a href="https://www.EWhisper.cn/tag/openshift.html">openshift</a>
      <a href="https://www.EWhisper.cn/tag/containers.html">containers</a>
      <a href="https://www.EWhisper.cn/tag/an-quan.html">å®‰å…¨</a>
    </p>
  </div>

  <div class="center social-share">
    <p>å–œæ¬¢è¿™ç¯‡æ–‡ç« å—ï¼Ÿå°†å®ƒä¸æ‚¨çš„æœ‹å‹åˆ†äº«å§ï¼</p>
    <div class="addthis_native_toolbox"></div>
    <div class="addthis_sharing_toolbox"></div>
    <div class="addthis_inline_share_toolbox"></div>
  </div>

  <div class="neighbors">
    <a class="btn float-left" href="https://www.EWhisper.cn/think-from-broken-to-k8s.html" title="æ€è€ƒ - ä»ä¼ ç»Ÿé›ªå´©åˆ°K8S">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="https://www.EWhisper.cn/how-to-tcpdump-in-k8s.html" title="Kubernetes ä¸­åˆ†æè°ƒè¯•ç½‘ç»œæµé‡çš„4ç§æ–¹å¼">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>æ‚¨å¯èƒ½è¿˜å–œæ¬¢</h4>
    <ul class="related-posts">
      <li><a href="https://www.EWhisper.cn/how-to-tcpdump-in-k8s.html">Kubernetes ä¸­åˆ†æè°ƒè¯•ç½‘ç»œæµé‡çš„4ç§æ–¹å¼</a></li>
      <li><a href="https://www.EWhisper.cn/container-best-practices.html">å®¹å™¨æœ€ä½³å®è·µ</a></li>
      <li><a href="https://www.EWhisper.cn/install-gitlab-with-docker.html">ä½¿ç”¨ Docker å®‰è£… Gitlab</a></li>
      <li><a href="https://www.EWhisper.cn/openshift-pod-autoscaling.html">å®¹å™¨è‡ªåŠ¨ä¼¸ç¼©</a></li>
      <li><a href="https://www.EWhisper.cn/openshift-and-kubernetes-whats-difference.html">OpenShift å’Œ Kubernetes æœ‰ä»€ä¹ˆåŒºåˆ«?</a></li>
    </ul>
  </div>


</article>

    <footer>
<p>
  &copy;  2020 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p><a href="http://beian.miit.gov.cn" target="_blank">æ²ªICPå¤‡19007314å·-1</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
<!-- StatusCake -->
<a href="https://www.statuscake.com" title="ä¸ªäººæŠ€æœ¯åˆ†äº« Uptime">
  <img src="https://app.statuscake.com/button/index.php?Track=CbJdcjmnCx&amp;Days=7&amp;Design=7" alt="ä¸ªäººæŠ€æœ¯åˆ†äº« Uptime"/>
</a>

<!-- End StatusCake --></p>    </footer>
  </main>


    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c98c3e21c4def55" async="async"></script>


<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " ä¸ªäººæŠ€æœ¯åˆ†äº« ",
  "url" : "https://www.EWhisper.cn",
  "image": "//s.gravatar.com/avatar/7c743bc6ac83171e35a5aa8bd66cc1ea?s=120",
  "description": "Focus on Python/Java/DevOps/Observability"
}
</script>

<a href="https://github.com/east4ming/my-pelican" class="github-corner" aria-label="View source on Github">
    <svg width="80"
         height="80"
         viewBox="0 0 250 250"
         style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
         aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px;"
              class="octo-arm">
        </path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body">
        </path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></body>
</html>