
<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://www.EWhisper.cn/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://www.EWhisper.cn/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://www.EWhisper.cn/theme/font-awesome/css/font-awesome.min.css">

    <link href="https://www.EWhisper.cn/static/custom.css" rel="stylesheet">


    <link href="https://www.EWhisper.cn/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="ä¸œé£å¾®é¸£ Blog RSS">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">


    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="ä¸œé£å¾®é¸£" />
<meta name="description" content="K8Sä¸­çš„åº”ç”¨å‡ºäº†é—®é¢˜, å¾€å¾€éœ€è¦è¿›è¡Œç½‘ç»œæŠ“åŒ…åˆ†æ. æœ¬æ–‡ä»‹ç»äº†åœ¨ Kubernetes ä¸­ç½‘ç»œè°ƒè¯•åˆ†æçš„3ç§æ–¹æ³•." />
<meta name="keywords" content="k8s, openshift, containers, æ€§èƒ½è°ƒä¼˜, ç½‘ç»œ, è¯‘æ–‡">

<meta property="og:site_name" content="ä¸œé£å¾®é¸£ Blog"/>
<meta property="og:title" content="Kubernetes ä¸­åˆ†æè°ƒè¯•ç½‘ç»œæµé‡çš„4ç§æ–¹å¼"/>
<meta property="og:description" content="K8Sä¸­çš„åº”ç”¨å‡ºäº†é—®é¢˜, å¾€å¾€éœ€è¦è¿›è¡Œç½‘ç»œæŠ“åŒ…åˆ†æ. æœ¬æ–‡ä»‹ç»äº†åœ¨ Kubernetes ä¸­ç½‘ç»œè°ƒè¯•åˆ†æçš„3ç§æ–¹æ³•."/>
<meta property="og:locale" content="zh_CN"/>
<meta property="og:url" content="https://www.EWhisper.cn/how-to-tcpdump-in-k8s.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-10-04 14:50:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://www.EWhisper.cn/author/dong-feng-wei-ming.html">
<meta property="article:section" content="DevOps"/>
<meta property="article:tag" content="k8s"/>
<meta property="article:tag" content="openshift"/>
<meta property="article:tag" content="containers"/>
<meta property="article:tag" content="æ€§èƒ½è°ƒä¼˜"/>
<meta property="article:tag" content="ç½‘ç»œ"/>
<meta property="article:tag" content="è¯‘æ–‡"/>
<meta property="og:image" content="//s.gravatar.com/avatar/7c743bc6ac83171e35a5aa8bd66cc1ea?s=120">

  <title>ä¸œé£å¾®é¸£ Blog &ndash; Kubernetes ä¸­åˆ†æè°ƒè¯•ç½‘ç»œæµé‡çš„4ç§æ–¹å¼</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://www.EWhisper.cn">
        <img src="//s.gravatar.com/avatar/7c743bc6ac83171e35a5aa8bd66cc1ea?s=120" alt="ä¸œé£å¾®é¸£" title="ä¸œé£å¾®é¸£">
      </a>
      <h1><a href="https://www.EWhisper.cn">ä¸œé£å¾®é¸£</a></h1>

<p>Focus on Python/Java/DevOps/Observability</p>
      <nav>
        <ul class="list">
          <li><a href="https://www.EWhisper.cn/pages/about.html#about">About</a></li>
          <li><a href="https://www.EWhisper.cn/pages/contact.html#contact">Contact</a></li>

          <li><a href="http://www.miitbeian.gov.cn/" target="_blank">æ²ªICPå¤‡19007314å·-1</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-wechat" href="/images/wechat_paycode.png" target="_blank"><i class="fa fa-wechat"></i></a></li>
        <li><a class="sc-envelope-o" href="mailto:cuikaidong@foxmail.com" target="_blank"><i class="fa fa-envelope-o"></i></a></li>
        <li><a class="sc-reddit" href="https://www.jianshu.com/u/0f08daeaa5a9" target="_blank"><i class="fa fa-reddit"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/å‡¯ä¸œ-å´”-136128116/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-weibo" href="https://weibo.com/long5to2gf" target="_blank"><i class="fa fa-weibo"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://www.EWhisper.cn">ä¸»é¡µ</a>

      <a href="/archives/index.html">å­˜æ¡£</a>
      <a href="/categories.html">ç±»åˆ«</a>
      <a href="/tags.html">æ ‡ç­¾</a>
      <a href="/authors.html">ä½œè€…</a>


      <a href="https://www.EWhisper.cn/feeds/all.rss.xml">RSSè®¢é˜…</a>
    </nav>

<article class="single">
  <header>
    <h1 id="how-to-tcpdump-in-k8s">Kubernetes ä¸­åˆ†æè°ƒè¯•ç½‘ç»œæµé‡çš„4ç§æ–¹å¼</h1>
    <p>
      åœ¨ 2019-10-04 Friday å‘å¸ƒäº <a href="https://www.EWhisper.cn/category/devops.html">DevOps</a> åˆ†ç±»

        &#8226; 3 min read
    </p>
  </header>


  <div>
    <div class="toc">
<ul>
<li><a href="#_1">å‰è¨€</a></li>
<li><a href="#-sidecar">æ–¹æ³•ä¸€ - ä½¿ç”¨ Sidecar</a><ul>
<li><a href="#sidecar">Sidecar å‰æ¥æ•‘æ´!</a></li>
<li><a href="#sidecar_1">éƒ¨ç½² Sidecar</a></li>
<li><a href="#_2">æ•è·å’Œåˆ†ææµé‡</a></li>
<li><a href="#_3">æ€»ç»“</a></li>
</ul>
</li>
<li><a href="#-netshoot">æ–¹æ³•äºŒ - ä½¿ç”¨ netshoot</a><ul>
<li><a href="#_4">ç”¨é€”</a></li>
<li><a href="#network-namespaces-">Network Namespaces - ç½‘ç»œåç§°ç©ºé—´</a></li>
<li><a href="#_5">é’ˆå¯¹å®¹å™¨çš„ç”¨æ³•</a></li>
<li><a href="#kubernetes">é’ˆå¯¹ Kubernetes çš„ç”¨æ³•</a></li>
<li><a href="#_6">ç½‘ç»œé—®é¢˜</a></li>
<li><a href="#_7">è¢«åŒ…å«çš„åŒ…</a></li>
</ul>
</li>
<li><a href="#-network-namespace">æ–¹æ³•ä¸‰ - åˆ©ç”¨Network Namespace</a></li>
<li><a href="#-kubectl-ksniff">æ–¹æ³•å›› - ä½¿ç”¨ kubectl æ’ä»¶ksniff</a><ul>
<li><a href="#krew-kubectl">é¢˜å¤–è¯: krew - kubectl æ’ä»¶åŒ…ç®¡ç†å™¨</a></li>
<li><a href="#ksniff">å®‰è£…ksniff</a></li>
<li><a href="#_8">ä½¿ç”¨æ–¹æ³•</a></li>
</ul>
</li>
<li><a href="#_9">æ€»ç»“</a></li>
</ul>
</div>
<h2 id="_1">å‰è¨€<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>åœ¨å½“ä»Šä¸–ç•Œ, åˆ†å¸ƒå¼ç³»ç»Ÿ, å¾®æœåŠ¡/SOAæ¶æ„éåœ°, æœåŠ¡ä¹‹é—´çš„è®¸å¤šäº¤äº’å’Œé€šä¿¡éƒ½ä¸å†æ˜¯åŒä¸€ä¸»æœºçš„ä¸åŒçº¿ç¨‹æˆ–è¿›ç¨‹, è€Œæ˜¯è·¨ä¸»æœº, ç”šè‡³è·¨ç½‘ç»œåŒºåŸŸ. é‚£ä¹ˆä¸€æ—¦ç›¸å…³æœåŠ¡å‡ºç°é—®é¢˜, æˆ‘ä»¬å°±ä¼šéœ€è¦è°ƒè¯•æœåŠ¡é—´çš„é€šè®¯, ä¸»æœºé—´çš„ç½‘ç»œ...</p>
<p><img alt="å¤æ‚çš„ç½‘ç»œæ¶æ„" src="images/smartscape-complex-environment-572-9c4b25ca16.png"></p>
<p>Kubernetes ä¸­çš„åº”ç”¨å‡ºäº†é—®é¢˜, å¾€å¾€éœ€è¦è¿›è¡Œç½‘ç»œæŠ“åŒ…åˆ†æ. æœ¬æ–‡ä»‹ç»äº†åœ¨ Kubernetes ä¸­ç½‘ç»œè°ƒè¯•åˆ†æçš„4ç§æ–¹æ³•.</p>
<ol>
<li>ä½¿ç”¨ sidecar</li>
<li>ä½¿ç”¨ <a href="https://github.com/nicolaka/netshoot">netshoot</a> - ä¸€ä¸ª Docker + Kubernetesç½‘ç»œæ•…éšœæ’é™¤çš„ç‘å£«å†›åˆ€å®¹å™¨</li>
<li>åˆ©ç”¨Network Namespace</li>
<li>ä½¿ç”¨ kubectl æ’ä»¶ - <code>ksniff</code></li>
</ol>
<h2 id="-sidecar">æ–¹æ³•ä¸€ - ä½¿ç”¨ Sidecar<a class="headerlink" href="#-sidecar" title="Permanent link">&para;</a></h2>
<blockquote>
<p><img align="absmiddle" alt="ğŸ““" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4d3.png" title=":notebook:" width="20px"> å¤‡æ³¨:</p>
<p>æœ¬ç« èŠ‚ä¸ºè¯‘æ–‡, åŸæ–‡é“¾æ¥: <a href="https://developers.redhat.com/blog/2019/02/27/sidecars-analyze-debug-network-traffic-kubernetes-pod/">çº¢å¸½å¼€å‘è€…åšå®¢ - Using sidecars to analyze and debug network traffic in OpenShift and Kubernetes pods</a></p>
<p><strong>By</strong> <a href="https://developers.redhat.com/blog/author/duncandoyle/">Duncan Doyle</a></p>
<p><strong>February 27, 2019</strong></p>
<p>sidecaråº”ç”¨èŒƒå›´ä¸ä»…ä»…æ­¢äºæ­¤, æ¯”å¦‚: APMç›‘æ§çš„agentå°±å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥æŒ‚è½½. è¯¦è§æˆ‘çš„å¦ä¸€ç¯‡åšæ–‡: <a href="https://www.EWhisper.cn/monitoring-docker-app-with-dynatrace.html">ä½¿ç”¨ Dynatrace AppMon ç›‘æ§ Docker åº”ç”¨</a></p>
</blockquote>
<p>åœ¨åˆ†å¸ƒå¼è®¡ç®—ã€å®¹å™¨å’Œå¾®æœåŠ¡çš„ä¸–ç•Œä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„è®¸å¤šäº¤äº’å’Œé€šä¿¡éƒ½æ˜¯é€šè¿‡RESTful apiå®Œæˆçš„ã€‚åœ¨å¼€å‘è¿™äº›apiå’ŒæœåŠ¡ä¹‹é—´çš„äº¤äº’æ—¶ï¼Œæˆ‘ç»å¸¸éœ€è¦è°ƒè¯•æœåŠ¡ä¹‹é—´çš„é€šä¿¡ï¼Œç‰¹åˆ«æ˜¯å½“äº‹æƒ…çœ‹èµ·æ¥ä¸åƒé¢„æœŸçš„é‚£æ ·å·¥ä½œæ—¶ã€‚</p>
<p>åœ¨å®¹å™¨å‡ºç°ä¹‹å‰ï¼Œæˆ‘åªéœ€å°†æœåŠ¡éƒ¨ç½²åˆ°æœ¬åœ°æœºå™¨ä¸Šï¼Œå¯åŠ¨Wiresharkï¼Œæ‰§è¡Œæµ‹è¯•ï¼Œå¹¶åˆ†ææœåŠ¡ä¹‹é—´çš„HTTPé€šä¿¡ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§å¿«é€Ÿåˆ†æè½¯ä»¶ä¸­é€šä¿¡é—®é¢˜çš„ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•ã€‚ç„¶è€Œï¼Œè¿™ç§è°ƒè¯•æ–¹æ³•åœ¨ä¸€ä¸ªå®¹å™¨åŒ–çš„ä¸–ç•Œä¸­å¹¶ä¸é€‚ç”¨ã€‚</p>
<p>é¦–å…ˆï¼Œå®¹å™¨å¾ˆå¯èƒ½åœ¨æ‚¨çš„æœºå™¨æ— æ³•ç›´æ¥è®¿é—®çš„å†…éƒ¨å®¹å™¨å¹³å°ç½‘ç»œä¸Šè¿è¡Œã€‚ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼ŒæŒ‰ç…§å®¹å™¨è®¾è®¡æœ€ä½³å®è·µï¼Œå®¹å™¨åªåŒ…å«æ‰§è¡Œå…¶ä»»åŠ¡æ‰€éœ€çš„æœ€å°åº”ç”¨ç¨‹åºå’Œåº“é›†ã€‚è¿™æ„å‘³ç€åƒtcpdumpè¿™æ ·çš„å·¥å…·é€šå¸¸åœ¨å®¹å™¨ä¸­ä¸å¯ç”¨ã€‚è¿™ä½¿å¾—è°ƒè¯•å’Œåˆ†æå®¹å™¨ä¹‹é—´çš„ç½‘ç»œé€šä¿¡å˜å¾—æ›´åŠ å›°éš¾ï¼Œä»è€Œä½¿å¾—è°ƒè¯•å¾®æœåŠ¡é—´çš„é€šä¿¡æ¯”åœ¨éå®¹å™¨ç¯å¢ƒä¸­æ›´åŠ å›°éš¾ã€‚æœ¬æ–‡å±•ç¤ºäº†ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚</p>
<h3 id="sidecar">Sidecar å‰æ¥æ•‘æ´!<a class="headerlink" href="#sidecar" title="Permanent link">&para;</a></h3>
<p><img alt="sidecar" src="images/sidecar.jpg"></p>
<p>åœ¨è¿‡å»çš„å‡ ä¸ªæœˆé‡Œï¼Œæˆ‘å°è¯•äº†å„ç§æ–¹æ³•æ¥å…‹æœè¿™ä¸ªé—®é¢˜ï¼Œæœ€ç»ˆå½¢æˆäº†æˆ‘å°†åœ¨æœ¬æ–‡ä¸­æ¦‚è¿°çš„æ–¹æ³•ã€‚å®ƒæ˜¯æ•è·Kubernetes/OpenShift podsä¹‹é—´çš„ç½‘ç»œæµé‡æ•°æ®çš„ç®€å•æ–¹æ³•ï¼Œå…è®¸å¼€å‘äººå‘˜æ›´å¥½åœ°åˆ†æå’Œè°ƒè¯•å®¹å™¨åŒ–åº”ç”¨ç¨‹åºä¸­çš„é€šä¿¡é—®é¢˜ï¼Œå¹¶æ›´å¿«ã€æ›´æœ‰æ•ˆåœ°è§£å†³é—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨tcpdumpæ•è·ä¸€ä¸ªæ‰€è°“çš„PCAP(packet capture)æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†åŒ…å«podçš„ç½‘ç»œæµé‡ã€‚ç„¶åå¯ä»¥å°†è¿™ä¸ªPCAPæ–‡ä»¶åŠ è½½åˆ°Wiresharkä¹‹ç±»çš„å·¥å…·ä¸­æ¥åˆ†ææµé‡ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œåˆ†æåœ¨podä¸­è¿è¡Œçš„æœåŠ¡çš„RESTfulé€šä¿¡ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨Red Hat Process Automation Manageräº§å“çš„KIEæœåŠ¡å™¨(æ‰§è¡ŒæœåŠ¡å™¨)ä½œä¸ºç¤ºä¾‹ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•åº”è¯¥é€‚ç”¨äºä»»ä½•ç±»å‹çš„å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚</p>
<p>è¦å…‹æœçš„ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯Kubernetes podä¸­tcpdumpå‘½ä»¤çš„å¯ç”¨æ€§ã€‚KIEæœåŠ¡å™¨å®¹å™¨æ˜ åƒæ²¡æœ‰å®‰è£…tcpdumpã€‚å…¶æ¬¡ï¼Œå®¹å™¨ä¸æä¾›ä»Red Hatå­˜å‚¨åº“å®‰è£…tcpdumpçš„å®ç”¨ç¨‹åºã€‚ä¸ºäº†å…‹æœè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†â€œsidecarå®¹å™¨â€çš„æ¦‚å¿µã€‚</p>
<h4>Sidecar æ¦‚å¿µ</h4>
<p>sidecarå®¹å™¨æ˜¯ä¸å®é™…æœåŠ¡/åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ç›¸åŒpodä¸­çš„å®¹å™¨ï¼Œèƒ½å¤Ÿä¸ºæœåŠ¡/åº”ç”¨ç¨‹åºæä¾›é™„åŠ åŠŸèƒ½ã€‚<strong>sidecarå®¹å™¨çš„ä¸€ä¸ªä¾‹å­æ˜¯Istioçš„Envoy sidecarï¼Œå®ƒä½¿podæˆä¸ºæœåŠ¡ç½‘æ ¼çš„ä¸€éƒ¨åˆ†</strong>ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†éƒ¨ç½²ä¸€ä¸ªsidecarå®¹å™¨ï¼Œè¯¥å®¹å™¨æä¾›tcpdumpå®ç”¨ç¨‹åºã€‚ç”±äº<strong>podä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ç›¸åŒçš„ç½‘ç»œå±‚</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨sidecaræ¥æ•è·è¿›å‡ºKIEæœåŠ¡å™¨çš„ç½‘ç»œæµé‡ã€‚</p>
<h3 id="sidecar_1">éƒ¨ç½² Sidecar<a class="headerlink" href="#sidecar_1" title="Permanent link">&para;</a></h3>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘éƒ¨ç½²äº†<a href="https://github.com/jbossdemocentral/rhpam7-mortgage-demo">Red Hat Process Automation Manager 7 Mortgage Demo</a>ï¼Œå®ƒå°†åœ¨æˆ‘çš„OpenShift namespaceä¸­åˆ›å»ºä¸¤ä¸ªpodã€‚ä¸€ä¸ªpodè¿è¡ŒBusiness Central workbenchï¼Œå¦ä¸€ä¸ªpodæ˜¯æ‰§è¡ŒæœåŠ¡å™¨çš„podã€‚è¿™ä¸¤ä¸ªç»„ä»¶ä¹‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡RESTå®Œæˆçš„ï¼Œè¿™æ˜¯æˆ‘ä»¬å°†è¦æ•è·çš„æµé‡ã€‚</p>
<p><img alt="OpenShift Namespace Overview" src="./images/Screenshot-2019-02-20-at-09.04.48.png"></p>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ•è·KIEæœåŠ¡å™¨podä¸Šçš„ç½‘ç»œæµé‡ï¼Œä»¥ä¾¿åˆ†æBusiness Central workbench å‘é€ç»™KIEæœåŠ¡å™¨çš„RESTfulå‘½ä»¤ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦é™„åŠ (attach)ä¸€ä¸ª sidecar åˆ°KIEæœåŠ¡å™¨çš„pod.</p>
<ol>
<li>
<p>åœ¨Overviewé¡µé¢ä¸­ï¼Œå•å‡»è¦åˆ†æçš„podçš„åç§°ã€‚è¿™å°†æ‰“å¼€<em>éƒ¨ç½²é…ç½®(Deployment Config, ç®€ç§°DC)</em>é¡µé¢ã€‚</p>
</li>
<li>
<p>åœ¨<em>éƒ¨ç½²é…ç½®</em>å±å¹•çš„å³ä¸Šè§’ï¼Œå•å‡»Actions -&gt; Edit YAMLã€‚è¿™å°†æ‰“å¼€DC çš„YAMLé…ç½®ã€‚</p>
<p><img alt="img" src="images/Screenshot-2019-02-20-at-09.08.55.png"></p>
</li>
<li>
<p>å‘ä¸‹æ»šåŠ¨ï¼Œç›´åˆ°çœ‹åˆ°å•è¯<code>containers</code>ã€‚æˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å®¹å™¨ï¼Œå®‰è£…äº†tcpdumpçš„sidecaråˆ°podä¸­ã€‚ç›´æ¥åœ¨<code>containers</code> å®šä¹‰ä¸‹æ·»åŠ ä»¥ä¸‹YAMLç‰‡æ®µ:</p>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tcpdump</span>
   <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">corfr/tcpdump</span>
   <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/bin/sleep</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">infinity</span>
</pre></div>


<p><img alt="img" src="images/Screenshot-2019-02-20-at-09.17.56.png"></p>
<ol start="4">
<li>ä¿å­˜é…ç½®ã€‚è¿™å°†éƒ¨ç½²ä¸€ä¸ªæ–°çš„podï¼Œå®ƒç°åœ¨ç”±ä¸¤ä¸ªå®¹å™¨ç»„æˆ:ä¸€ä¸ªå®¹å™¨åŒ…å«KIEæœåŠ¡å™¨ï¼Œå¦ä¸€ä¸ªå®¹å™¨åŒ…å«æˆ‘ä»¬çš„tcpdumpå·¥å…·ï¼Œå®ƒå°†æ— é™æœŸåœ°æŒç»­è¿è¡Œã€‚</li>
</ol>
<h3 id="_2">æ•è·å’Œåˆ†ææµé‡<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p>éšç€sidecarçš„éƒ¨ç½²å’Œè¿è¡Œï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å¼€å§‹æ•è·æ•°æ®äº†ã€‚æˆ‘å°è¯•çš„æ–¹æ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨<code>oc rsh</code>å‘½ä»¤è¿œç¨‹æ‰§è¡Œsidecarä¸­çš„<code>tcpdump</code>å‘½ä»¤ï¼Œå°†ç½‘ç»œæ•°æ®æµè¾“å‡ºåˆ°FIFOæ–‡ä»¶ï¼Œå¹¶å°†æ•°æ®ç›´æ¥å¯¼å…¥Wiresharkã€‚ç”±äºå„ç§åŸå› ï¼Œè¿™ç§æ–¹æ³•å¤±è´¥äº†ã€‚å…¶ä¸­ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œ<code>tcpdump</code>å‘<code>stderr</code>å‘é€ä¿¡æ¯æ¶ˆæ¯ï¼Œä½†æ˜¯è¿™äº›æ¶ˆæ¯ä¸<code>stdout</code>åœ¨ç›¸åŒçš„æµä¸­, å¹¶ä¸”æ˜¯é€šè¿‡SSHæ¥æ”¶ï¼Œä»è€Œç ´åäº†è¿›å…¥Wiresharkçš„æ•°æ®ã€‚</p>
<p>æˆ‘æœ€åä½¿ç”¨çš„æ–¹æ³•æ˜¯ç™»å½•åˆ°sidecarå®¹å™¨ï¼Œå¹¶åœ¨sidecarä¸­è¿è¡Œ<code>tcpdump</code>å‘½ä»¤æ¥åˆ›å»ºPCAPæ–‡ä»¶ã€‚å½“æ‚¨æ•è·äº†è¶³å¤Ÿçš„æ•°æ®åï¼Œå°±å¯ä»¥åœæ­¢æ•è·è¿‡ç¨‹å¹¶å°†PCAPæ–‡ä»¶å¤åˆ¶åˆ°æ‚¨å¸Œæœ›ä½¿ç”¨Wiresharkè¿›è¡Œç½‘ç»œæµé‡åˆ†æçš„æœºå™¨ä¸Šã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p>
<ol>
<li>
<p>åœ¨æ‚¨çš„å¼€å‘æœºå™¨ä¸Šï¼Œç”¨<code>oc</code> å®¢æˆ·ç«¯è¿æ¥åˆ°OpenShiftå®ä¾‹ï¼Œå¹¶æ¿€æ´»æ­£ç¡®çš„é¡¹ç›®(project, å³namespace)ï¼Œè¿è¡Œ<code>oc get pods</code>å‘½ä»¤æ¥åˆ—å‡ºæ‚¨çš„pods:</p>
<p><img alt="oc get pods" src="images/Screenshot-2019-02-20-at-09.26.30.png"></p>
</li>
<li>
<p>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç™»å½•åˆ°æˆ‘ä»¬çš„KIEæœåŠ¡å™¨podçš„tcpdumpå®¹å™¨ä¸­:<code>oc rsh -c tcpdump rhpam7-mortgage-kieserver-2-zcpsn</code></p>
</li>
<li>
<p>åœ¨<code>tcpdump</code>å®¹å™¨ä¸­ï¼Œè¿è¡Œæ­¤å‘½ä»¤ä»¥å¯åŠ¨ç½‘ç»œæµé‡æ•è·è¿‡ç¨‹: <code>tcpdump -s 0 -n -w /tmp/kieserver.pcap</code></p>
</li>
<li>
<p>è¿è¡Œè¦åˆ†æçš„ç½‘ç»œæµé‡çš„æµ‹è¯•ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘å°†ä»Business Central workbenchä¸­å¯åŠ¨ä¸€ä¸ªä¸šåŠ¡æµç¨‹ï¼Œå®ƒå°†å‘KIEæœåŠ¡å™¨å‘é€ä¸€ä¸ªRESTfulè¯·æ±‚ã€‚</p>
</li>
<li>
<p>æ•è·è¶³å¤Ÿçš„æ•°æ®åï¼Œåœ¨<code>tcpdump</code>å®¹å™¨ä¸­ä½¿ç”¨<code>Ctrl+C</code>å®Œæˆæ•è·è¿‡ç¨‹ã€‚</p>
</li>
<li>
<p>å›åˆ°æœ¬åœ°æœºå™¨ã€‚å°†PCAPæ–‡ä»¶ä»podå¤åˆ¶åˆ°æœ¬åœ°æœºå™¨: <code>oc cp -c tcpdump rhpam7-mortgage-kieserver-2-zcpsn:tmp/kieserver.pcap kieserver.pcap</code></p>
</li>
<li>
<p>ç”¨Wiresharkæ‰“å¼€PCAPæ–‡ä»¶å¹¶åˆ†æç½‘ç»œæµé‡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘æ­£åœ¨åˆ†ææˆ‘çš„HTTP POSTæ–¹æ³•ï¼Œå®ƒåˆ›å»ºäº†Mortgage è¿›ç¨‹çš„ä¸€ä¸ªæ–°å®ä¾‹:</p>
<p><img alt="wireshark åˆ†æ" src="images/Screenshot-2019-02-20-at-09.45.47.png"></p>
</li>
</ol>
<h3 id="_3">æ€»ç»“<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>åœ¨å®¹å™¨ç¯å¢ƒ(å¦‚Kuberneteså’Œ/æˆ–OpenShift)ä¸­åˆ†æpodä¹‹é—´çš„ç½‘ç»œé€šä¿¡å¯èƒ½æ¯”åœ¨éå®¹å™¨ç¯å¢ƒä¸­æ›´å›°éš¾ä¸€äº›ã€‚ç„¶è€Œï¼Œsidecarå®¹å™¨çš„æ¦‚å¿µä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ç§ç®€å•çš„å·¥å…·ï¼Œå¯ä»¥å°†å®¹å™¨è¿åŒæ‰€éœ€çš„å¼€å‘å·¥å…·å’Œå®ç”¨ç¨‹åºé™„åŠ åˆ°å¾®æœåŠ¡podä¸Šã€‚<strong>è¿™é¿å…äº†å¼€å‘äººå‘˜å¿…é¡»åœ¨åº”ç”¨ç¨‹åºå®¹å™¨æ˜ åƒæœ¬èº«ä¸­å®‰è£…è¿™äº›è°ƒè¯•å·¥å…·ï¼Œä»è€Œä¿æŒå®¹å™¨çš„è½»ä¾¿å’Œå¹²å‡€ã€‚</strong>ä½¿ç”¨åƒ<code>oc rsh</code>å’Œ<code>oc cp</code>è¿™æ ·çš„OpenShiftå·¥å…·ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•è½»æ¾åœ°ä»podæ•è·ç½‘ç»œæµé‡æ•°æ®å¹¶å°†æ•°æ®å¸¦åˆ°å¼€å‘æœºå™¨è¿›è¡Œåˆ†æã€‚</p>
<h2 id="-netshoot">æ–¹æ³•äºŒ - ä½¿ç”¨ netshoot<a class="headerlink" href="#-netshoot" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/nicolaka/netshoot">Netshoot</a> - Docker + Kubernetesç½‘ç»œæ•…éšœæ’é™¤çš„ç‘å£«å†›åˆ€å®¹å™¨</p>
<p><img alt="ç‘å£«å†›åˆ€" src="images/403141.jpg"></p>
<h3 id="_4">ç”¨é€”<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>Dockerå’ŒKubernetesç½‘ç»œæ•…éšœæ’é™¤å˜å¾—å¤æ‚ã€‚é€šè¿‡æ­£ç¡®ç†è§£Dockerå’ŒKubernetesç½‘ç»œçš„å·¥ä½œæ–¹å¼å’Œæ­£ç¡®çš„å·¥å…·é›†ï¼Œæ‚¨å¯ä»¥æ’é™¤æ•…éšœå¹¶è§£å†³è¿™äº›ç½‘ç»œé—®é¢˜ã€‚netshootå®¹å™¨æœ‰ä¸€ç»„å¼ºå¤§çš„ç½‘ç»œtroubleshootå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥æ’é™¤Dockerç½‘ç»œé—®é¢˜ã€‚ä¸è¿™äº›å·¥å…·ä¸€èµ·å‡ºç°çš„è¿˜æœ‰ä¸€ç»„ç”¨ä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨çœŸå®åœºæ™¯ä¸­ä½¿ç”¨è¿™ä¸ªå®¹å™¨ã€‚</p>
<h3 id="network-namespaces-">Network Namespaces - ç½‘ç»œåç§°ç©ºé—´<a class="headerlink" href="#network-namespaces-" title="Permanent link">&para;</a></h3>
<p>åœ¨å¼€å§‹ä½¿ç”¨è¿™ä¸ªå·¥å…·ä¹‹å‰ï¼Œæœ‰ä¸€ç‚¹å¾ˆé‡è¦:ç½‘ç»œåç§°ç©ºé—´ã€‚ç½‘ç»œåç§°ç©ºé—´æä¾›ä¸ç½‘ç»œç›¸å…³çš„ç³»ç»Ÿèµ„æºçš„éš”ç¦»ã€‚Dockerä½¿ç”¨ç½‘ç»œå’Œå…¶ä»–ç±»å‹çš„åç§°ç©ºé—´(<code>pid</code>ã€<code>mount</code>ã€<code>user</code>...)ä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ªéš”ç¦»çš„ç¯å¢ƒã€‚ä»æ¥å£ã€è·¯ç”±åˆ°ipçš„æ‰€æœ‰å†…å®¹éƒ½å®Œå…¨éš”ç¦»åœ¨å®¹å™¨çš„ç½‘ç»œåç§°ç©ºé—´ä¸­ã€‚</p>
<p>Kubernetesä¹Ÿä½¿ç”¨ç½‘ç»œåç§°ç©ºé—´ã€‚<strong>Kubeletsä¸ºæ¯ä¸ªpodåˆ›å»ºä¸€ä¸ªç½‘ç»œåç§°ç©ºé—´ï¼Œå…¶ä¸­è¯¥podä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº«ç›¸åŒçš„ç½‘ç»œåç§°ç©ºé—´(ethsã€IPã€tcpå¥—æ¥å­—â€¦â€¦)ã€‚è¿™æ˜¯Dockerå®¹å™¨å’ŒKubernetes podä¹‹é—´çš„å…³é”®åŒºåˆ«ã€‚</strong></p>
<p>åç§°ç©ºé—´å¾ˆé…·çš„ä¸€ç‚¹æ˜¯æ‚¨å¯ä»¥åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚æ‚¨å¯ä»¥è¾“å…¥ä¸åŒå®¹å™¨çš„ç½‘ç»œåç§°ç©ºé—´ï¼Œä½¿ç”¨ç”šè‡³æ²¡æœ‰å®‰è£…åœ¨è¯¥å®¹å™¨ä¸Šçš„å·¥å…·åœ¨å…¶ç½‘ç»œå †æ ˆä¸Šæ‰§è¡Œä¸€äº›æ•…éšœæ’é™¤ã€‚æ­¤å¤–ï¼Œnetshootå¯ä»¥é€šè¿‡ä½¿ç”¨ä¸»æœºçš„ç½‘ç»œåç§°ç©ºé—´æ¥å¯¹ä¸»æœºæœ¬èº«è¿›è¡Œæ•…éšœæ’é™¤ã€‚è¿™å…è®¸æ‚¨åœ¨ä¸ç›´æ¥åœ¨ä¸»æœºæˆ–åº”ç”¨ç¨‹åºåŒ…ä¸Šå®‰è£…ä»»ä½•æ–°åŒ…çš„æƒ…å†µä¸‹æ‰§è¡Œä»»ä½•æ•…éšœæ’é™¤ã€‚</p>
<h3 id="_5">é’ˆå¯¹å®¹å™¨çš„ç”¨æ³•<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>å®¹å™¨çš„ç½‘ç»œåç§°ç©ºé—´</strong>:å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºçš„å®¹å™¨å­˜åœ¨ç½‘ç»œé—®é¢˜ï¼Œæ‚¨å¯ä»¥åƒè¿™æ ·ä½¿ç”¨å®¹å™¨çš„ç½‘ç»œåç§°ç©ºé—´å¯åŠ¨netshoot: <code>$ docker run -it --net container:&lt;container_name&gt; nicolaka/netshoot</code></li>
<li><strong>ä¸»æœºçš„ç½‘ç»œåç§°ç©ºé—´</strong>:å¦‚æœæ‚¨è®¤ä¸ºç½‘ç»œé—®é¢˜åœ¨äºä¸»æœºæœ¬èº«ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¯¥ä¸»æœºçš„ç½‘ç»œåç§°ç©ºé—´å¯åŠ¨netshootã€‚å‘½ä»¤: <code>$ docker run -it --net host nicolaka/netshoot</code></li>
<li><strong>ç½‘ç»œçš„ç½‘ç»œåç§°ç©ºé—´</strong>:å¦‚æœè¦å¯¹Dockerç½‘ç»œè¿›è¡Œæ•…éšœæ’é™¤ï¼Œå¯ä»¥ä½¿ç”¨<code>nsenter</code>è¾“å…¥ç½‘ç»œçš„åç§°ç©ºé—´ã€‚è¿™å°†åœ¨ä¸‹é¢çš„<code>nsenter</code>éƒ¨åˆ†è¿›è¡Œè§£é‡Šã€‚</li>
</ul>
<h3 id="kubernetes">é’ˆå¯¹ Kubernetes çš„ç”¨æ³•<a class="headerlink" href="#kubernetes" title="Permanent link">&para;</a></h3>
<p><strong>Kubernetes</strong>:å¦‚æœä½ æƒ³æ‰“å¼€ä¸€ä¸ªä¸´æ—¶çš„å®¹å™¨æ¥è°ƒè¯•ã€‚</p>
<p><code>$ kubectl run --generator=run-pod/v1 tmp-shell --rm -i --tty --image nicolaka/netshoot -- /bin/bash</code></p>
<p>å¦‚æœæ‚¨æƒ³åœ¨ä¸»æœºçš„ç½‘ç»œåç§°ç©ºé—´ä¸Šspin upä¸€ä¸ªå®¹å™¨ã€‚</p>
<p><code>$ kubectl run tmp-shell --generator=run-pod/v1 --rm -i --tty --overrides='{"spec": {"hostNetwork": true}}' --image nicolaka/netshoot -- /bin/bash</code></p>
<blockquote>
<p><img align="absmiddle" alt="ğŸ““" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4d3.png" title=":notebook:" width="20px"> å¤‡æ³¨:</p>
<p>åŒæ ·çš„åŸç†, <code>netshoot</code>ä¹Ÿå¯ä»¥é€šè¿‡sidecarçš„æ–¹å¼è¿›è¡Œä½¿ç”¨.</p>
</blockquote>
<h3 id="_6">ç½‘ç»œé—®é¢˜<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>è®¸å¤šç½‘ç»œé—®é¢˜å¯èƒ½å¯¼è‡´åº”ç”¨ç¨‹åºæ€§èƒ½ä¸‹é™ã€‚å…¶ä¸­ä¸€äº›é—®é¢˜å¯èƒ½ä¸åº•å±‚ç½‘ç»œåŸºç¡€è®¾æ–½æœ‰å…³ã€‚å…¶ä»–é—®é¢˜å¯èƒ½ä¸ä¸»æœºæˆ–Dockerçº§åˆ«çš„é…ç½®é”™è¯¯æœ‰å…³ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¸¸è§çš„ç½‘ç»œé—®é¢˜</p>
<ul>
<li>å»¶è¿Ÿ(latency)</li>
<li>è·¯ç”±(routing)</li>
<li>DNSè§£æ(DNS resolution)</li>
<li>é˜²ç«å¢™(firewall)</li>
<li>ä¸å®Œæ•´çš„ARP(incomplete ARPs)</li>
</ul>
<p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œ<code>netshoot</code>åŒ…å«äº†ä¸€ç»„å¼ºå¤§çš„å·¥å…·ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p>
<p><img alt="netshoot å·¥å…·é›†" src="images/netshoot-all-tools.png"></p>
<h3 id="_7">è¢«åŒ…å«çš„åŒ…<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>ä»¥ä¸‹åŒ…è¢«åŒ…å«åœ¨<code>netshoot</code>ä¸­ã€‚</p>
<div class="highlight"><pre><span></span><span class="n">apache2</span><span class="o">-</span><span class="n">utils</span>
<span class="n">bash</span>
<span class="n">bind</span><span class="o">-</span><span class="n">tools</span>
<span class="n">bird</span>
<span class="n">bridge</span><span class="o">-</span><span class="n">utils</span>
<span class="n">busybox</span><span class="o">-</span><span class="n">extras</span>
<span class="n">calicoctl</span>
<span class="n">conntrack</span><span class="o">-</span><span class="n">tools</span>
<span class="n">ctop</span>
<span class="n">curl</span>
<span class="n">dhcping</span>
<span class="n">drill</span>
<span class="n">ethtool</span>
<span class="n">file</span>
<span class="n">fping</span>
<span class="n">iftop</span>
<span class="n">iperf</span>
<span class="n">iproute2</span>
<span class="n">ipset</span>
<span class="n">iptables</span>
<span class="n">iptraf</span><span class="o">-</span><span class="n">ng</span>
<span class="n">iputils</span>
<span class="n">ipvsadm</span>
<span class="n">libc6</span><span class="o">-</span><span class="n">compat</span>
<span class="n">liboping</span>
<span class="n">mtr</span>
<span class="n">net</span><span class="o">-</span><span class="n">snmp</span><span class="o">-</span><span class="n">tools</span>
<span class="n">netcat</span><span class="o">-</span><span class="n">openbsd</span>
<span class="n">netgen</span>
<span class="n">nftables</span>
<span class="n">ngrep</span>
<span class="n">nmap</span>
<span class="n">nmap</span><span class="o">-</span><span class="n">nping</span>
<span class="n">openssl</span>
<span class="n">py</span><span class="o">-</span><span class="n">crypto</span>
<span class="n">py2</span><span class="o">-</span><span class="n">virtualenv</span>
<span class="n">python2</span>
<span class="n">scapy</span>
<span class="n">socat</span>
<span class="n">strace</span>
<span class="n">tcpdump</span>
<span class="n">tcptraceroute</span>
<span class="n">util</span><span class="o">-</span><span class="n">linux</span>
<span class="n">vim</span>
</pre></div>


<h2 id="-network-namespace">æ–¹æ³•ä¸‰ - åˆ©ç”¨Network Namespace<a class="headerlink" href="#-network-namespace" title="Permanent link">&para;</a></h2>
<p>æ­£å¦‚<a href="#Network Namespaces - ç½‘ç»œåç§°ç©ºé—´">æ–¹æ³•äºŒä¸­æåˆ°çš„Network Namespace</a>æ¦‚å¿µ, å®é™…ä¸Š, ä¸åŒçš„å®¹å™¨, <strong>åªæ˜¯åœ¨å®¿ä¸»æœºä¸Šä¸åŒ namespace è¿è¡Œçš„è¿›ç¨‹è€Œå·²</strong>. å› æ­¤è¦åœ¨ä¸åŒçš„å®¹å™¨æŠ“åŒ…å¯ä»¥ç®€å•åœ°ä½¿ç”¨å‘½ä»¤åˆ‡æ¢ network namespace å³å¯ï¼Œå¯ä»¥ä½¿ç”¨åœ¨å®¿ä¸»æœºä¸Šçš„ <code>tcpdump</code> ç­‰åº”ç”¨è¿›è¡ŒæŠ“åŒ…ã€‚</p>
<blockquote>
<p><img align="absmiddle" alt="ğŸ““" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4d3.png" title=":notebook:" width="20px"> å¤‡æ³¨:</p>
<p>å‰ææ¡ä»¶: å®¿ä¸»æœºä¸Šå·²å®‰è£…<code>tcpdump</code></p>
<p>å‚è€ƒé“¾æ¥: <a href="https://ruofeng.me/2018/09/19/capture-packets-in-kubernetes/">åœ¨ k8s ä¸­å¯¹æŒ‡å®š Pod è¿›è¡ŒæŠ“åŒ…</a></p>
</blockquote>
<p>å…·ä½“æ“ä½œæ­¥éª¤å¦‚ä¸‹:</p>
<ol>
<li>æŸ¥çœ‹æŒ‡å®š pod è¿è¡Œåœ¨å“ªä¸ªå®¿ä¸»æœºä¸Š: <code>kubctl describe pod &lt;pod&gt; -n mservice</code></li>
<li>è·å¾—å®¹å™¨çš„ pid: <code>docker inspect -f {{.State.Pid}} &lt;container&gt;</code></li>
<li>è¿›å…¥è¯¥å®¹å™¨çš„ network namespace: <code>nsenter --target &lt;PID&gt; -n</code></li>
<li>ä½¿ç”¨å®¿ä¸»æœºçš„<code>tcpdump</code> æŠ“åŒ…, æŒ‡å®š eth0 ç½‘å¡: <code>tcpdump -i eth0 tcp and port 80 -vvv</code></li>
<li>æˆ–è€…ç›´æ¥æŠ“åŒ…å¹¶å¯¼å‡ºåˆ°æ–‡ä»¶: <code>tcpdump -i eth0 -w /tmp/out.cap</code></li>
<li>ä»è¿œç¨‹ <code>scp</code> åˆ°æœ¬åœ°: <code>scp ipaddr:/tmp/out.cap ./</code></li>
<li>ä¹‹ååœ¨ Wireshark ä¸­å¯ä»¥æ‰“å¼€æ–‡ä»¶éå¸¸ç›´è§‚å¾—æŸ¥çœ‹è¿‡æ»¤æŠ“åˆ°çš„æ•°æ®ã€‚</li>
</ol>
<h2 id="-kubectl-ksniff">æ–¹æ³•å›› - ä½¿ç”¨ kubectl æ’ä»¶<code>ksniff</code><a class="headerlink" href="#-kubectl-ksniff" title="Permanent link">&para;</a></h2>
<blockquote>
<p><img align="absmiddle" alt="ğŸ““" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4d3.png" title=":notebook:" width="20px"> å¤‡æ³¨:</p>
<p><a href="https://github.com/eldadru/ksniff">Github: ksniff</a></p>
<p><img align="absmiddle" alt="â—" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/2757.png" title=":exclamation:" width="20px"> æ³¨æ„:</p>
<p><strong>Ksniffè¿˜æ²¡æœ‰ä¸ºç”Ÿäº§åšå¥½å‡†å¤‡ï¼Œç›®å‰ä¸å»ºè®®ä¸ºç”Ÿäº§å·¥ä½œè´Ÿè½½è¿è¡ŒKsniffã€‚</strong></p>
</blockquote>
<h3 id="krew-kubectl">é¢˜å¤–è¯: krew - kubectl æ’ä»¶åŒ…ç®¡ç†å™¨<img align="absmiddle" alt="ğŸ“¦" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4e6.png" title=":package:" width="20px"><a class="headerlink" href="#krew-kubectl" title="Permanent link">&para;</a></h3>
<blockquote>
<p><img align="absmiddle" alt="ğŸ““" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4d3.png" title=":notebook:" width="20px"> å¤‡æ³¨:</p>
<p>å‰ææ¡ä»¶: kubectl v1.12æˆ–æ›´é«˜.</p>
<p><a href="https://github.com/kubernetes-sigs/krew/">Github: krew</a></p>
</blockquote>
<p>Krewæ˜¯kubectlæ’ä»¶çš„åŒ…ç®¡ç†å™¨ã€‚(åç»­ä¼šä½¿ç”¨krewæ¥å®‰è£…<code>ksniff</code>, æ–¹ä¾¿å¾ˆå¤š)</p>
<h4>ä»€ä¹ˆæ˜¯ <code>krew</code></h4>
<p><img align="absmiddle" alt="ğŸ“¦" class="emojione" height="20px" src="https://cdn.jsdelivr.net/emojione/assets/4.5/png/64/1f4e6.png" title=":package:" width="20px"> â€‹krewæ˜¯ä¸€ä¸ªä½¿<a href="https://kubernetes.io/docs/tasks/extend-kubectl/kubectl-plugins/">kubectlæ’ä»¶</a>æ˜“äºä½¿ç”¨çš„å·¥å…·ã€‚krewå¸®åŠ©æ‚¨å‘ç°æ’ä»¶ï¼Œå¹¶åœ¨æ‚¨çš„æœºå™¨ä¸Šå®‰è£…å’Œç®¡ç†å®ƒä»¬ã€‚å®ƒç±»ä¼¼äºaptã€dnfæˆ–brewç­‰å·¥å…·ã€‚</p>
<ul>
<li><strong>å¯¹äº kubectl ç”¨æˆ·</strong>: krewå¸®åŠ©æ‚¨ä»¥ä¸€è‡´çš„æ–¹å¼æŸ¥æ‰¾ã€å®‰è£…å’Œç®¡ç†kubectlæ’ä»¶ã€‚</li>
</ul>
<p>krew æ˜“äºä½¿ç”¨:</p>
<div class="highlight"><pre><span></span>kubectl krew search                 <span class="c1"># show all plugins</span>
kubectl krew install view-secret    <span class="c1"># install a plugin named &quot;view-secret&quot;</span>
kubectl view-secret                 <span class="c1"># use the plugin</span>
kubectl krew upgrade                <span class="c1"># upgrade installed plugins</span>
kubectl krew uninstall view-secret  <span class="c1"># uninstall a plugin</span>
</pre></div>


<p>è¯¦ç»†æ–‡æ¡£è¯·å‚é˜…<a href="https://github.com/kubernetes-sigs/krew/blob/master/docs/USER_GUIDE.md">ç”¨æˆ·æŒ‡å—</a>ã€‚</p>
<p>æŸ¥çœ‹åœ¨krewä¸Š<a href="http://sigs.k8s.io/krew-index/plugins.md">å¯ç”¨çš„kubectlæ’ä»¶åˆ—è¡¨</a>ï¼Œæˆ–è€…è¿è¡Œ<code>kubectl krew search</code>æ¥å‘ç°å¯ç”¨çš„æ’ä»¶ã€‚</p>
<h4>å®‰è£… krew</h4>
<p><strong>Bash å’Œ ZSH</strong>:</p>
<ol>
<li>ç¡®ä¿<code>git</code> å·²å®‰è£…;</li>
<li>è¿è¡Œå¦‚ä¸‹å‘½ä»¤, ä¸‹è½½å¹¶å®‰è£…<code>krew</code></li>
</ol>
<div class="highlight"><pre><span></span><span class="o">(</span>
  <span class="nb">set</span> -x<span class="p">;</span> <span class="nb">cd</span> <span class="s2">&quot;</span><span class="k">$(</span>mktemp -d<span class="k">)</span><span class="s2">&quot;</span> <span class="o">&amp;&amp;</span>
  curl -fsSLO <span class="s2">&quot;https://github.com/kubernetes-sigs/krew/releases/download/v0.3.1/krew.{tar.gz,yaml}&quot;</span> <span class="o">&amp;&amp;</span>
  tar zxvf krew.tar.gz <span class="o">&amp;&amp;</span>
  ./krew-<span class="s2">&quot;</span><span class="k">$(</span>uname <span class="p">|</span> tr <span class="s1">&#39;[:upper:]&#39;</span> <span class="s1">&#39;[:lower:]&#39;</span><span class="k">)</span><span class="s2">_amd64&quot;</span> install <span class="se">\</span>
    --manifest<span class="o">=</span>krew.yaml --archive<span class="o">=</span>krew.tar.gz
<span class="o">)</span>
</pre></div>


<ol start="3">
<li>æ·»åŠ <code>$HOME/.krew/bin</code> ç›®å½•åˆ°<code>PATH</code>ç¯å¢ƒå˜é‡. å¦‚ä¸‹: <code>export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"</code> å¹¶é‡å¯ä¸‹shellç”Ÿæ•ˆ.</li>
</ol>
<h3 id="ksniff">å®‰è£…<code>ksniff</code><a class="headerlink" href="#ksniff" title="Permanent link">&para;</a></h3>
<p>é€šè¿‡<code>krew</code>: <code>kubectl krew install sniff</code></p>
<h3 id="_8">ä½¿ç”¨æ–¹æ³•<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><span class="nv">kubectl</span> <span class="o">&lt;</span> <span class="mi">1</span>.<span class="mi">12</span>:
<span class="nv">kubectl</span> <span class="nv">plugin</span> <span class="nv">sniff</span> <span class="o">&lt;</span><span class="nv">POD_NAME</span><span class="o">&gt;</span> [<span class="o">-</span><span class="nv">n</span> <span class="o">&lt;</span><span class="nv">NAMESPACE_NAME</span><span class="o">&gt;</span>] [<span class="o">-</span><span class="nv">c</span> <span class="o">&lt;</span><span class="nv">CONTAINER_NAME</span><span class="o">&gt;</span>] [<span class="o">-</span><span class="nv">i</span> <span class="o">&lt;</span><span class="nv">INTERFACE_NAME</span><span class="o">&gt;</span>] [<span class="o">-</span><span class="nv">f</span> <span class="o">&lt;</span><span class="nv">CAPTURE_FILTER</span><span class="o">&gt;</span>] [<span class="o">-</span><span class="nv">o</span> <span class="nv">OUTPUT_FILE</span>] [<span class="o">-</span><span class="nv">l</span> <span class="nv">LOCAL_TCPDUMP_FILE</span>] [<span class="o">-</span><span class="nv">r</span> <span class="nv">REMOTE_TCPDUMP_FILE</span>]

<span class="nv">kubectl</span> <span class="o">&gt;=</span> <span class="mi">1</span>.<span class="mi">12</span>:
<span class="nv">kubectl</span> <span class="nv">sniff</span> <span class="o">&lt;</span><span class="nv">POD_NAME</span><span class="o">&gt;</span> [<span class="o">-</span><span class="nv">n</span> <span class="o">&lt;</span><span class="nv">NAMESPACE_NAME</span><span class="o">&gt;</span>] [<span class="o">-</span><span class="nv">c</span> <span class="o">&lt;</span><span class="nv">CONTAINER_NAME</span><span class="o">&gt;</span>] [<span class="o">-</span><span class="nv">i</span> <span class="o">&lt;</span><span class="nv">INTERFACE_NAME</span><span class="o">&gt;</span>] [<span class="o">-</span><span class="nv">f</span> <span class="o">&lt;</span><span class="nv">CAPTURE_FILTER</span><span class="o">&gt;</span>] [<span class="o">-</span><span class="nv">o</span> <span class="nv">OUTPUT_FILE</span>] [<span class="o">-</span><span class="nv">l</span> <span class="nv">LOCAL_TCPDUMP_FILE</span>] [<span class="o">-</span><span class="nv">r</span> <span class="nv">REMOTE_TCPDUMP_FILE</span>]

<span class="nv">POD_NAME</span>: <span class="nv">Required</span>. <span class="nv">the</span> <span class="nv">name</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">kubernetes</span> <span class="nv">pod</span> <span class="nv">to</span> <span class="nv">start</span> <span class="nv">capture</span> <span class="nv">it</span><span class="s1">&#39;</span><span class="s">s traffic.</span>
<span class="nv">NAMESPACE_NAME</span>: <span class="nv">Optional</span>. <span class="nv">Namespace</span> <span class="nv">name</span>. <span class="nv">used</span> <span class="nv">to</span> <span class="nv">specify</span> <span class="nv">the</span> <span class="nv">target</span> <span class="nv">namespace</span> <span class="nv">to</span> <span class="nv">operate</span> <span class="nv">on</span>.
<span class="nv">CONTAINER_NAME</span>: <span class="nv">Optional</span>. <span class="k">If</span> <span class="nv">omitted</span>, <span class="nv">the</span> <span class="nv">first</span> <span class="nv">container</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">pod</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">chosen</span>.
<span class="nv">INTERFACE_NAME</span>: <span class="nv">Optional</span>. <span class="nv">Pod</span> <span class="nv">Interface</span> <span class="nv">to</span> <span class="nv">capture</span> <span class="nv">from</span>. <span class="k">If</span> <span class="nv">omited</span>, <span class="nv">all</span> <span class="nv">Pod</span> <span class="nv">interfaces</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">captured</span>.
<span class="nv">CAPTURE_FILTER</span>: <span class="nv">Optional</span>. <span class="nv">specify</span> <span class="nv">a</span> <span class="nv">specific</span> <span class="nv">tcpdump</span> <span class="nv">capture</span> <span class="nv">filter</span>. <span class="k">If</span> <span class="nv">omitted</span> <span class="nv">no</span> <span class="nv">filter</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">used</span>.
<span class="nv">OUTPUT_FILE</span>: <span class="nv">Optional</span>. <span class="k">if</span> <span class="nv">specified</span>, <span class="nv">ksniff</span> <span class="nv">will</span> <span class="nv">redirect</span> <span class="nv">tcpdump</span> <span class="nv">output</span> <span class="nv">to</span> <span class="nv">local</span> <span class="nv">file</span> <span class="nv">instead</span> <span class="nv">of</span> <span class="nv">wireshark</span>.
<span class="nv">LOCAL_TCPDUMP_FILE</span>: <span class="nv">Optional</span>. <span class="k">if</span> <span class="nv">specified</span>, <span class="nv">ksniff</span> <span class="nv">will</span> <span class="nv">use</span> <span class="nv">this</span> <span class="nv">path</span> <span class="nv">as</span> <span class="nv">the</span> <span class="nv">local</span> <span class="nv">path</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">static</span> <span class="nv">tcpdump</span> <span class="nv">binary</span>.
<span class="nv">REMOTE_TCPDUMP_FILE</span>: <span class="nv">Optional</span>. <span class="k">if</span> <span class="nv">specified</span>, <span class="nv">ksniff</span> <span class="nv">will</span> <span class="nv">use</span> <span class="nv">the</span> <span class="nv">specified</span> <span class="nv">path</span> <span class="nv">as</span> <span class="nv">the</span> <span class="nv">remote</span> <span class="nv">path</span> <span class="nv">to</span> <span class="nv">upload</span> <span class="nv">static</span> <span class="nv">tcpdump</span> <span class="nv">to</span>.
</pre></div>


<p>ä¸¾ä¾‹:</p>
<p><code>kubectl sniff mypod -n myproject -o /tmp/mypod.pcap</code></p>
<h2 id="_9">æ€»ç»“<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>ä¸ºäº†åœ¨å®¹å™¨æˆ–K8Sä¸­è¿›è¡Œç½‘ç»œè°ƒè¯•å’Œåˆ†æ, æœ¬æ–‡åˆ—ä¸¾äº†4ç§æ–¹æ³•, ç°åœ¨è¿›è¡Œæ€»ç»“å½’çº³:</p>
<ol>
<li>ä½¿ç”¨ sidecar - sidecar å®¹å™¨æ‰€åœ¨çš„<strong>podä¸­çš„å¤šä¸ªå®¹å™¨å…±äº«ç›¸åŒçš„ç½‘ç»œå±‚</strong>, ä¸”sidecarå®¹å™¨å¯ä»¥åŒ…å«<code>tcpdump</code>ç­‰å·¥å…·;</li>
<li>åˆ©ç”¨Network Namespace -  ä¸åŒçš„å®¹å™¨, <strong>åªæ˜¯åœ¨å®¿ä¸»æœºä¸Šä¸åŒ namespace è¿è¡Œçš„è¿›ç¨‹è€Œå·²</strong>. å®¹å™¨çš„ç½‘ç»œä¹Ÿæ˜¯å¦‚æ­¤.</li>
<li>ä½¿ç”¨<code>netshoot</code> - <code>netshoot</code> å…¶å®æ˜¯åŒ…å«ä¸€ç³»åˆ—çš„å¸¸ç”¨ç½‘ç»œåˆ†æè°ƒè¯•å·¥å…·é›†çš„å®¹å™¨, çœŸæ­£çš„ä½¿ç”¨æ–¹æ³•å…¶å®è¿˜æ˜¯ä»¥ä¸Š2ç§:<ol>
<li>é€šè¿‡ sidecaræŒ‚è½½</li>
<li>åˆ©ç”¨Network Namespaceåˆ†æè°ƒè¯•</li>
</ol>
</li>
<li>ä½¿ç”¨ kubectl æ’ä»¶ - <code>ksniff</code>. <em>ä¸ªäººçŒœæƒ³, è¿™ä¸ªåªæ˜¯ä¸€ä¸ªé€šè¿‡ kubectl æ’ä»¶çš„å°è£…, åº•å±‚åŸç†åº”è¯¥è¿˜æ˜¯ Network Namespace.</em></li>
</ol>
<p>ä»¥ä¸Šè¿™äº›æ–¹æ³•, æœ‰ä¸åŒçš„å‰ææ¡ä»¶å’Œä½¿ç”¨åœºæ™¯, å¸Œæœ›æœ¬æ–‡è¯»å®Œä¼šè®©ä½ çš„K8Sè°ƒè¯•æŠ€èƒ½æœ‰æ‰€æå‡. </p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://www.EWhisper.cn/tag/k8s.html">k8s</a>
      <a href="https://www.EWhisper.cn/tag/openshift.html">openshift</a>
      <a href="https://www.EWhisper.cn/tag/containers.html">containers</a>
      <a href="https://www.EWhisper.cn/tag/xing-neng-diao-you.html">æ€§èƒ½è°ƒä¼˜</a>
      <a href="https://www.EWhisper.cn/tag/wang-luo.html">ç½‘ç»œ</a>
      <a href="https://www.EWhisper.cn/tag/yi-wen.html">è¯‘æ–‡</a>
    </p>
  </div>

  <div class="center social-share">
    <p>å–œæ¬¢è¿™ç¯‡æ–‡ç« å—ï¼Ÿå°†å®ƒä¸æ‚¨çš„æœ‹å‹åˆ†äº«å§ï¼</p>
    <div class="addthis_native_toolbox"></div>
    <div class="addthis_sharing_toolbox"></div>
    <div class="addthis_inline_share_toolbox"></div>
  </div>

  <div class="neighbors">
    <a class="btn float-left" href="https://www.EWhisper.cn/how-to-run-container-with-su-in-openshift.html" title="å¦‚ä½•åœ¨ OpenShift ä¸­è¿è¡Œ Collabora Office">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="https://www.EWhisper.cn/how-to-manager-nginx-using-ansible.html" title="Ansible æ–°æ‰‹æŒ‡å— - å¦‚ä½•æ‰¹é‡ç®¡ç† NGINX">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>æ‚¨å¯èƒ½è¿˜å–œæ¬¢</h4>
    <ul class="related-posts">
      <li><a href="https://www.EWhisper.cn/how-to-run-container-with-su-in-openshift.html">å¦‚ä½•åœ¨ OpenShift ä¸­è¿è¡Œ Collabora Office</a></li>
      <li><a href="https://www.EWhisper.cn/analyze-k8s-difficult-problems-10s-delay.html">Kubernetes ç–‘éš¾é—®é¢˜æ’æŸ¥ - 10s å»¶è¿Ÿ</a></li>
      <li><a href="https://www.EWhisper.cn/container-best-practices.html">å®¹å™¨æœ€ä½³å®è·µ</a></li>
      <li><a href="https://www.EWhisper.cn/install-gitlab-with-docker.html">ä½¿ç”¨ Docker å®‰è£… Gitlab</a></li>
      <li><a href="https://www.EWhisper.cn/openshift-pod-autoscaling.html">å®¹å™¨è‡ªåŠ¨ä¼¸ç¼©</a></li>
    </ul>
  </div>


</article>

    <footer>
<p>
  &copy;  2019 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>æœ¬ç«™ç”± <a href="http://getpelican.com" target="_blank">Pelican</a> é©±åŠ¨ï¼Œå¹¶ä½¿ç”¨äº† <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a> å¼€å‘çš„ <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> ä¸»é¢˜ã€‚</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
<!-- StatusCake -->
<a href="https://www.statuscake.com" title="ä¸œé£å¾®é¸£ Blog Uptime">
  <img src="https://app.statuscake.com/button/index.php?Track=CbJdcjmnCx&amp;Days=7&amp;Design=7" alt="ä¸œé£å¾®é¸£ Blog Uptime"/>
</a>

<!-- End StatusCake --></p>    </footer>
  </main>


    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5c98c3e21c4def55" async="async"></script>


<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " ä¸œé£å¾®é¸£ Blog ",
  "url" : "https://www.EWhisper.cn",
  "image": "//s.gravatar.com/avatar/7c743bc6ac83171e35a5aa8bd66cc1ea?s=120",
  "description": "Focus on Python/Java/DevOps/Observability"
}
</script>

<a href="https://github.com/east4ming/my-pelican" class="github-corner" aria-label="View source on Github">
    <svg width="80"
         height="80"
         viewBox="0 0 250 250"
         style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;"
         aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor"
              style="transform-origin: 130px 106px;"
              class="octo-arm">
        </path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor"
              class="octo-body">
        </path>
    </svg>
</a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></body>
</html>